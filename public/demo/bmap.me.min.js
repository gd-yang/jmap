!function(a){"function"==typeof define?define(a):"function"==typeof YUI?YUI.add("es5",a):a()}(function(){function a(a){return a=+a,a!==a?a=0:0!==a&&a!==1/0&&a!==-(1/0)&&(a=(a>0||-1)*Math.floor(Math.abs(a))),a}function b(a){var b=typeof a;return null===a||"undefined"===b||"boolean"===b||"number"===b||"string"===b}function c(a){var c,d,e;if(b(a))return a;if(d=a.valueOf,"function"==typeof d&&(c=d.call(a),b(c)))return c;if(e=a.toString,"function"==typeof e&&(c=e.call(a),b(c)))return c;throw new TypeError}Function.prototype.bind||(Function.prototype.bind=function(a){var b=this;if("function"!=typeof b)throw new TypeError("Function.prototype.bind called on incompatible "+b);var c=l.call(arguments,1),d=function(){if(this instanceof d){var e=b.apply(this,c.concat(l.call(arguments)));return Object(e)===e?e:this}return b.apply(a,c.concat(l.call(arguments)))};return b.prototype&&(d.prototype=Object.create(b.prototype)),d});var d,e,f,g,h,i=Function.prototype.call,j=Array.prototype,k=Object.prototype,l=j.slice,m=i.bind(k.toString),n=i.bind(k.hasOwnProperty);if((h=n(k,"__defineGetter__"))&&(d=i.bind(k.__defineGetter__),e=i.bind(k.__defineSetter__),f=i.bind(k.__lookupGetter__),g=i.bind(k.__lookupSetter__)),2!=[1,2].splice(0).length){var o=Array.prototype.splice;Array.prototype.splice=function(a,b){return arguments.length?o.apply(this,[void 0===a?0:a,void 0===b?this.length-a:b].concat(l.call(arguments,2))):[]}}Array.isArray||(Array.isArray=function(a){return"[object Array]"==m(a)});var p=Object("a"),q="a"!=p[0]||!(0 in p);if(Array.prototype.forEach||(Array.prototype.forEach=function(a){var b=E(this),c=q&&"[object String]"==m(this)?this.split(""):b,d=arguments[1],e=-1,f=c.length>>>0;if("[object Function]"!=m(a))throw new TypeError;for(;++e<f;)e in c&&a.call(d,c[e],e,b)}),Array.prototype.map||(Array.prototype.map=function(a){var b=E(this),c=q&&"[object String]"==m(this)?this.split(""):b,d=c.length>>>0,e=Array(d),f=arguments[1];if("[object Function]"!=m(a))throw new TypeError(a+" is not a function");for(var g=0;d>g;g++)g in c&&(e[g]=a.call(f,c[g],g,b));return e}),Array.prototype.filter||(Array.prototype.filter=function(a){var b,c=E(this),d=q&&"[object String]"==m(this)?this.split(""):c,e=d.length>>>0,f=[],g=arguments[1];if("[object Function]"!=m(a))throw new TypeError(a+" is not a function");for(var h=0;e>h;h++)h in d&&(b=d[h],a.call(g,b,h,c)&&f.push(b));return f}),Array.prototype.every||(Array.prototype.every=function(a){var b=E(this),c=q&&"[object String]"==m(this)?this.split(""):b,d=c.length>>>0,e=arguments[1];if("[object Function]"!=m(a))throw new TypeError(a+" is not a function");for(var f=0;d>f;f++)if(f in c&&!a.call(e,c[f],f,b))return!1;return!0}),Array.prototype.some||(Array.prototype.some=function(a){var b=E(this),c=q&&"[object String]"==m(this)?this.split(""):b,d=c.length>>>0,e=arguments[1];if("[object Function]"!=m(a))throw new TypeError(a+" is not a function");for(var f=0;d>f;f++)if(f in c&&a.call(e,c[f],f,b))return!0;return!1}),Array.prototype.reduce||(Array.prototype.reduce=function(a){var b=E(this),c=q&&"[object String]"==m(this)?this.split(""):b,d=c.length>>>0;if("[object Function]"!=m(a))throw new TypeError(a+" is not a function");if(!d&&1==arguments.length)throw new TypeError("reduce of empty array with no initial value");var e,f=0;if(arguments.length>=2)e=arguments[1];else for(;;){if(f in c){e=c[f++];break}if(++f>=d)throw new TypeError("reduce of empty array with no initial value")}for(;d>f;f++)f in c&&(e=a.call(void 0,e,c[f],f,b));return e}),Array.prototype.reduceRight||(Array.prototype.reduceRight=function(a){var b=E(this),c=q&&"[object String]"==m(this)?this.split(""):b,d=c.length>>>0;if("[object Function]"!=m(a))throw new TypeError(a+" is not a function");if(!d&&1==arguments.length)throw new TypeError("reduceRight of empty array with no initial value");var e,f=d-1;if(arguments.length>=2)e=arguments[1];else for(;;){if(f in c){e=c[f--];break}if(--f<0)throw new TypeError("reduceRight of empty array with no initial value")}do f in this&&(e=a.call(void 0,e,c[f],f,b));while(f--);return e}),Array.prototype.indexOf&&-1==[0,1].indexOf(1,2)||(Array.prototype.indexOf=function(b){var c=q&&"[object String]"==m(this)?this.split(""):E(this),d=c.length>>>0;if(!d)return-1;var e=0;for(arguments.length>1&&(e=a(arguments[1])),e=e>=0?e:Math.max(0,d+e);d>e;e++)if(e in c&&c[e]===b)return e;return-1}),Array.prototype.lastIndexOf&&-1==[0,1].lastIndexOf(0,-3)||(Array.prototype.lastIndexOf=function(b){var c=q&&"[object String]"==m(this)?this.split(""):E(this),d=c.length>>>0;if(!d)return-1;var e=d-1;for(arguments.length>1&&(e=Math.min(e,a(arguments[1]))),e=e>=0?e:d-Math.abs(e);e>=0;e--)if(e in c&&b===c[e])return e;return-1}),!Object.keys){var r=!0,s=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],t=s.length;for(var u in{toString:null})r=!1;Object.keys=function F(a){if("object"!=typeof a&&"function"!=typeof a||null===a)throw new TypeError("Object.keys called on a non-object");var F=[];for(var b in a)n(a,b)&&F.push(b);if(r)for(var c=0,d=t;d>c;c++){var e=s[c];n(a,e)&&F.push(e)}return F}}var v=-621987552e5,w="-000001";Date.prototype.toISOString&&-1!==new Date(v).toISOString().indexOf(w)||(Date.prototype.toISOString=function(){var a,b,c,d,e;if(!isFinite(this))throw new RangeError("Date.prototype.toISOString called on non-finite value.");for(d=this.getUTCFullYear(),e=this.getUTCMonth(),d+=Math.floor(e/12),e=(e%12+12)%12,a=[e+1,this.getUTCDate(),this.getUTCHours(),this.getUTCMinutes(),this.getUTCSeconds()],d=(0>d?"-":d>9999?"+":"")+("00000"+Math.abs(d)).slice(d>=0&&9999>=d?-4:-6),b=a.length;b--;)c=a[b],10>c&&(a[b]="0"+c);return d+"-"+a.slice(0,2).join("-")+"T"+a.slice(2).join(":")+"."+("000"+this.getUTCMilliseconds()).slice(-3)+"Z"});var x=!1;try{x=Date.prototype.toJSON&&null===new Date(0/0).toJSON()&&-1!==new Date(v).toJSON().indexOf(w)&&Date.prototype.toJSON.call({toISOString:function(){return!0}})}catch(y){}if(x||(Date.prototype.toJSON=function(){var a,b=Object(this),d=c(b);if("number"==typeof d&&!isFinite(d))return null;if(a=b.toISOString,"function"!=typeof a)throw new TypeError("toISOString property is not callable");return a.call(b)}),Date=function(a){function b(c,d,e,f,g,h,i){var j=arguments.length;if(this instanceof a){var k=1==j&&String(c)===c?new a(b.parse(c)):j>=7?new a(c,d,e,f,g,h,i):j>=6?new a(c,d,e,f,g,h):j>=5?new a(c,d,e,f,g):j>=4?new a(c,d,e,f):j>=3?new a(c,d,e):j>=2?new a(c,d):j>=1?new a(c):new a;return k.constructor=b,k}return a.apply(this,arguments)}function c(a,b){var c=b>1?1:0;return e[b]+Math.floor((a-1969+c)/4)-Math.floor((a-1901+c)/100)+Math.floor((a-1601+c)/400)+365*(a-1970)}var d=new RegExp("^(\\d{4}|[+-]\\d{6})(?:-(\\d{2})(?:-(\\d{2})(?:T(\\d{2}):(\\d{2})(?::(\\d{2})(?:\\.(\\d{3}))?)?(Z|(?:([-+])(\\d{2}):(\\d{2})))?)?)?)?$"),e=[0,31,59,90,120,151,181,212,243,273,304,334,365];for(var f in a)b[f]=a[f];return b.now=a.now,b.UTC=a.UTC,b.prototype=a.prototype,b.prototype.constructor=b,b.parse=function(b){var e=d.exec(b);if(e){var f,g=Number(e[1]),h=Number(e[2]||1)-1,i=Number(e[3]||1)-1,j=Number(e[4]||0),k=Number(e[5]||0),l=Number(e[6]||0),m=Number(e[7]||0),n=!e[4]||e[8]?0:Number(new a(1970,0)),o="-"===e[9]?1:-1,p=Number(e[10]||0),q=Number(e[11]||0);return(k>0||l>0||m>0?24:25)>j&&60>k&&60>l&&1e3>m&&h>-1&&12>h&&24>p&&60>q&&i>-1&&i<c(g,h+1)-c(g,h)&&(f=60*(24*(c(g,h)+i)+j+p*o),f=1e3*(60*(f+k+q*o)+l)+m+n,f>=-864e13&&864e13>=f)?f:0/0}return a.parse.apply(this,arguments)},b}(Date),Date.now||(Date.now=function(){return(new Date).getTime()}),"0".split(void 0,0).length){var z=String.prototype.split;String.prototype.split=function(a,b){return void 0===a&&0===b?[]:z.apply(this,arguments)}}if("".substr&&"b"!=="0b".substr(-1)){var A=String.prototype.substr;String.prototype.substr=function(a,b){return A.call(this,0>a?(a=this.length+a)<0?0:a:a,b)}}var B="	\n\f\r   ᠎             　\u2028\u2029﻿";if(!String.prototype.trim||B.trim()){B="["+B+"]";var C=new RegExp("^"+B+B+"*"),D=new RegExp(B+B+"*$");String.prototype.trim=function(){if(void 0===this||null===this)throw new TypeError("can't convert "+this+" to object");return String(this).replace(C,"").replace(D,"")}}var E=function(a){if(null==a)throw new TypeError("can't convert "+a+" to object");return Object(a)}}),function(a){"function"==typeof define?define(a):"function"==typeof YUI?YUI.add("es5-sham",a):a()}(function(){function a(a){try{return a.sentinel=0,0===Object.getOwnPropertyDescriptor(a,"sentinel").value}catch(b){}}function b(a){try{return Object.defineProperty(a,"sentinel",{}),"sentinel"in a}catch(b){}}var c,d,e,f,g,h=Function.prototype.call,i=Object.prototype,j=h.bind(i.hasOwnProperty);if((g=j(i,"__defineGetter__"))&&(c=h.bind(i.__defineGetter__),d=h.bind(i.__defineSetter__),e=h.bind(i.__lookupGetter__),f=h.bind(i.__lookupSetter__)),Object.getPrototypeOf||(Object.getPrototypeOf=function(a){return a.__proto__||(a.constructor?a.constructor.prototype:i)}),Object.defineProperty){var k=a({}),l="undefined"==typeof document||a(document.createElement("div"));if(!l||!k)var m=Object.getOwnPropertyDescriptor}if(!Object.getOwnPropertyDescriptor||m){var n="Object.getOwnPropertyDescriptor called on a non-object: ";Object.getOwnPropertyDescriptor=function(a,b){if("object"!=typeof a&&"function"!=typeof a||null===a)throw new TypeError(n+a);if(m)try{return m.call(Object,a,b)}catch(c){}if(j(a,b)){var d={enumerable:!0,configurable:!0};if(g){var h=a.__proto__;a.__proto__=i;var k=e(a,b),l=f(a,b);if(a.__proto__=h,k||l)return k&&(d.get=k),l&&(d.set=l),d}return d.value=a[b],d.writable=!0,d}}}if(Object.getOwnPropertyNames||(Object.getOwnPropertyNames=function(a){return Object.keys(a)}),!Object.create){var o,p=null===Object.prototype.__proto__;o=p||"undefined"==typeof document?function(){return{__proto__:null}}:function(){function a(){}var b=document.createElement("iframe"),c=document.body||document.documentElement;b.style.display="none",c.appendChild(b),b.src="javascript:";var d=b.contentWindow.Object.prototype;return c.removeChild(b),b=null,delete d.constructor,delete d.hasOwnProperty,delete d.propertyIsEnumerable,delete d.isPrototypeOf,delete d.toLocaleString,delete d.toString,delete d.valueOf,d.__proto__=null,a.prototype=d,o=function(){return new a},new a},Object.create=function(a,b){function c(){}var d;if(null===a)d=o();else{if("object"!=typeof a&&"function"!=typeof a)throw new TypeError("Object prototype may only be an Object or null");c.prototype=a,d=new c,d.__proto__=a}return void 0!==b&&Object.defineProperties(d,b),d}}if(Object.defineProperty){var q=b({}),r="undefined"==typeof document||b(document.createElement("div"));if(!q||!r)var s=Object.defineProperty,t=Object.defineProperties}if(!Object.defineProperty||s){var u="Property description must be an object: ",v="Object.defineProperty called on non-object: ",w="getters & setters can not be defined on this javascript engine";Object.defineProperty=function(a,b,h){if("object"!=typeof a&&"function"!=typeof a||null===a)throw new TypeError(v+a);if("object"!=typeof h&&"function"!=typeof h||null===h)throw new TypeError(u+h);if(s)try{return s.call(Object,a,b,h)}catch(k){}if(j(h,"value"))if(g&&(e(a,b)||f(a,b))){var l=a.__proto__;a.__proto__=i,delete a[b],a[b]=h.value,a.__proto__=l}else a[b]=h.value;else{if(!g)throw new TypeError(w);j(h,"get")&&c(a,b,h.get),j(h,"set")&&d(a,b,h.set)}return a}}(!Object.defineProperties||t)&&(Object.defineProperties=function(a,b){if(t)try{return t.call(Object,a,b)}catch(c){}for(var d in b)j(b,d)&&"__proto__"!=d&&Object.defineProperty(a,d,b[d]);return a}),Object.seal||(Object.seal=function(a){return a}),Object.freeze||(Object.freeze=function(a){return a});try{Object.freeze(function(){})}catch(x){Object.freeze=function(a){return function(b){return"function"==typeof b?b:a(b)}}(Object.freeze)}Object.preventExtensions||(Object.preventExtensions=function(a){return a}),Object.isSealed||(Object.isSealed=function(){return!1}),Object.isFrozen||(Object.isFrozen=function(){return!1}),Object.isExtensible||(Object.isExtensible=function(a){if(Object(a)!==a)throw new TypeError;for(var b="";j(a,b);)b+="?";a[b]=!0;var c=j(a,b);return delete a[b],c})}),function(){function type(a){return function(b){return Object.prototype.toString.call(b)=="[object "+a+"]"}}function parseXML(a){if("string"!=typeof a||!a)return null;var b,c;try{window.DOMParser?(c=new DOMParser,b=c.parseFromString(a,"text/xml")):(b=new ActiveXObject("Microsoft.XMLDOM"),b.async="false",b.loadXML(a))}catch(d){b=void 0}if(!b||!b.documentElement||b.getElementsByTagName("parsererror").length)throw new Error("Invalid XML: "+a);return b}function parseJSON(datas){return window.JSON?JSON.parse(datas):eval("("+datas+")")}function parseJS(datas){return eval("("+datas+")")}function ObjSerialize(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c+"="+a[c]);return b.join("&")||""}function noop(){}function FlashAjax(){this.property={headers:{"content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}},this.onload=noop}function _XMLHttpRequest(){return new XMLHttpRequest}function _XDomainRequest(){return new XDomainRequest}function _FlaCrossRequest(){return new FlashAjax}function createCrossXHR(a){return a||!supports.xhr2?(FlashAjax.install("/mapeditor/swf/request.swf"),_FlaCrossRequest()):supports.xhr2?_XMLHttpRequest():null}function createXHR(){var a=null;if("undefined"!=typeof XMLHttpRequest)a=_XMLHttpRequest();else if("undefined"!=typeof ActiveXObject)try{return a=MSXML2()}catch(b){return a=MSXML()}return a}function XHR(a){a=a||{},this.cross=!!a.cross;var b=!!a.fla;this.xhr=this.cross===!0?createCrossXHR(b):createXHR()}var isStr=type("String"),isFn=type("Function"),isArr=type("Array"),isObj=type("Object"),supports={xhr2:!!XMLHttpRequest&&"withCredentials"in new XMLHttpRequest},_flash=null,_fla_isready=!1,_fla_lock=!1,_fla_pg=0,_fla_gui=0,_fla_loadstacks=[];FlashAjax.callbacks={},FlashAjax.prototype.open=function(a,b){a=a.toLowerCase(),this.property.type=a,this.property.url=b},FlashAjax.prototype.send=function(a){this.property.paras=a;var b=this,c=_fla_gui++,d=this.property,e=d.type,f=d.url,g=(d.headers.contentType,d.headers),h="FlashAjax.callbacks["+c+"]";return FlashAjax.callbacks[c]=function(a){b.responseXml=b.responseText=a,b.onload(b)},a=isObj(d.paras)?ObjSerialize(d.paras||{}):a,_fla_isready?void _flash.sendRequest(f,h,e,a,g,"utf-8"):void _fla_loadstacks.push(this.format(f,h,e,a,g,"utf-8"))},FlashAjax.prototype.setRequestHeader=function(a,b){this.property.headers[a]=b},FlashAjax.prototype.setRequestHeaders=function(a){a=a||{};for(var b in a)a.hasOwnProperty(b)&&(this.property.headers[b]=a[b])},FlashAjax.prototype.format=function(a,b,c,d,e,f){return function(){_flash.sendRequest(a,b,c,d,e,f)}},FlashAjax.install=function(a){if(!_fla_lock){var b="cross_domain_for_ie_fla";a=a||"/mapeditor/swf/request.swf";var c="";c+='<object data="'+a+'" type="application/x-shockwave-flash"',c+='id="'+b+'" width="0" height="0">',c+='<param name="allowScriptAccess" value="always">',c+='<param name="swliveconnect" value="true">',c+='<param name="movie" value="'+a+'">',c+='<param name="wmode" value="opaque">',c+="</object>";var d=document.createElement("DIV");d.id="cross_domain_for_ie_con",d.innerHTML=c,d.style.cssText="height:0;width:0;line-height:0;font-size:0;",document.body.appendChild(d),_flash=document.getElementById("cross_domain_for_ie_fla"),_fla_lock=!0,FlashAjax.PercentCheck()}},FlashAjax.PercentCheck=function(){try{_fla_pg=_flash.PercentLoaded()}catch(a){}100>_fla_pg?setTimeout(FlashAjax.PercentCheck,100):FlashAjax.ready()},FlashAjax.ready=function(){var a=0,b=_fla_loadstacks,c=b.length;for(_fla_isready=!0;c>a;a++)b[a]();_fla_loadstacks=[]},window.FlashAjax=FlashAjax;var MSXML2=function(){return new ActiveXObject("MSXML2.XMLHTTP")},MSXML=function(){return new ActiveXObject("Microsoft.XMLHTTP")};XHR.prototype={constructor:XHR,DONE:4,LOADING:3,HEADERS_RECEIVED:2,OPENED:1,UNSENT:0,ajax:function(a,b,c,d){"function"==typeof c&&(d=c,c={}),c=c||{},a=a.toLowerCase();var e=c.async!==!1,f=c.paras||{},g=c.override||"text/xml; charset=utf-8",h=c.timeout||3e5,i=c.username,j=c.pwd,k=c.headers||{},l=c.contentType||"application/x-www-form-urlencoded; charset=utf-8";this.success=c.success||null,this.xhr.onerror=c.error||null,this.resDataType=c.resDataType||"responseText",this.onLoad(d),b="get"==a?b+((-1===b.indexOf("?")?"?":"&")+ObjSerialize(f)):b,this.open(a,b,e,i,j),this.setRequestHeader("Content-type",l),this.cross||this.setRequestHeaders(k),h&&"timeout"in this.xhr&&(this.xhr.timeout=h),this.overrideMimeType(g),this.send("post"==a?f:null)},get:function(a,b,c){this.ajax("GET",a,b,c)},getJSON:function(a,b,c){isFn(b)&&(c=b,b={}),this.ajax("GET",a,b,function(a){c(parseJSON(a))})},getXML:function(a,b,c){isFn(b)&&(c=b,b={}),b.override&&/^(text|application)\/xml$/.test(b.override)||(b.override="text/xml"),this.ajax("GET",a,b,function(a){return a=isStr(a)?parseXML(a):a,c(a)})},post:function(a,b,c){this.ajax("POST",a,b,c)},open:function(a,b,c,d,e){isFn(this._onopen)&&this._onopen(),this.xhr.open(a,b,c,d,e)},send:function(a){isFn(this._onsend)&&this._onsend(),a=isObj(a)?ObjSerialize(a):a,this.xhr.send(a)},getAllResponseHeaders:function(){return this.xhr.getAllResponseHeaders()},getResponseHeader:function(a){return this.xhr.getResponseHeader(a)},setRequestHeader:function(a,b){this.xhr.setRequestHeader(a,b)},setRequestHeaders:function(a){for(var b in a)a.hasOwnProperty(b)&&this.xhr.setRequestHeader(b,a[b])},overrideMimeType:function(a){"overrideMimeType"in this.xhr&&this.xhr.overrideMimeType(a)},abort:function(){this.xhr.abort(),isFn(this._onabort)&&this._onabort()},onOpen:function(a){"onopen"in this.xhr?this.xhr.onopen=a:this._onopen=a},onAbort:function(a){"onabort"in this.xhr?this.xhr.onabort=a:this._onabort=a},onProgress:function(a){this.xhr.onprogress=a},onTimeout:function(a){var b=this.xhr;"ontimeout"in b?this.xhr.ontimeout=a:setTimeout(function(){4!==b.readyState&&(a(),b.abort())},this.timeout)},onLoad:function(a){var b=this;"onload"in this.xhr?this.xhr.onload=function(){a(b.xhr[b.resDataType],status,b.xhr,b),b.onSuccess(b.xhr[b.resDataType],status,b.xhr,b)}:this.xhr.onreadystatechange=function(){switch(b.xhr.readyState){case b.LOADING:isFn(b._loading)&&b._loading();break;case b.DONE:var c=b.xhr.status;(c>=200&&300>c||304==c)&&(a(b.xhr[b.resDataType],c,b.xhr,b),b.onSuccess(b.xhr[b.resDataType],c,b.xhr,b))}}},onError:function(a){"onerror"in this.xhr?this.xhr.onerror=a:this._onerror=a},onSuccess:function(){var a=Array.prototype.slice.call(arguments);this.success&&"function"==typeof this.success&&this.success.apply(this,a)},toString:function(){return"[object XHR]"}},window.XHR=XHR}(),eval(function(a,b,c,d,e,f){if(e=function(a){return(b>a?"":e(parseInt(a/b)))+((a%=b)>35?String.fromCharCode(a+29):a.toString(36))},!"".replace(/^/,String)){for(;c--;)f[e(c)]=d[c]||e(c);d=[function(a){return f[a]}],e=function(){return"\\w+"},c=1}for(;c--;)d[c]&&(a=a.replace(new RegExp("\\b"+e(c)+"\\b","g"),d[c]));return a}("9 17={3i:'0.1.3',16:1e-6};l v(){}v.23={e:l(i){8(i<1||i>7.4.q)?w:7.4[i-1]},2R:l(){8 7.4.q},1u:l(){8 F.1x(7.2u(7))},24:l(a){9 n=7.4.q;9 V=a.4||a;o(n!=V.q){8 1L}J{o(F.13(7.4[n-1]-V[n-1])>17.16){8 1L}}H(--n);8 2x},1q:l(){8 v.u(7.4)},1b:l(a){9 b=[];7.28(l(x,i){b.19(a(x,i))});8 v.u(b)},28:l(a){9 n=7.4.q,k=n,i;J{i=k-n;a(7.4[i],i+1)}H(--n)},2q:l(){9 r=7.1u();o(r===0){8 7.1q()}8 7.1b(l(x){8 x/r})},1C:l(a){9 V=a.4||a;9 n=7.4.q,k=n,i;o(n!=V.q){8 w}9 b=0,1D=0,1F=0;7.28(l(x,i){b+=x*V[i-1];1D+=x*x;1F+=V[i-1]*V[i-1]});1D=F.1x(1D);1F=F.1x(1F);o(1D*1F===0){8 w}9 c=b/(1D*1F);o(c<-1){c=-1}o(c>1){c=1}8 F.37(c)},1m:l(a){9 b=7.1C(a);8(b===w)?w:(b<=17.16)},34:l(a){9 b=7.1C(a);8(b===w)?w:(F.13(b-F.1A)<=17.16)},2k:l(a){9 b=7.2u(a);8(b===w)?w:(F.13(b)<=17.16)},2j:l(a){9 V=a.4||a;o(7.4.q!=V.q){8 w}8 7.1b(l(x,i){8 x+V[i-1]})},2C:l(a){9 V=a.4||a;o(7.4.q!=V.q){8 w}8 7.1b(l(x,i){8 x-V[i-1]})},22:l(k){8 7.1b(l(x){8 x*k})},x:l(k){8 7.22(k)},2u:l(a){9 V=a.4||a;9 i,2g=0,n=7.4.q;o(n!=V.q){8 w}J{2g+=7.4[n-1]*V[n-1]}H(--n);8 2g},2f:l(a){9 B=a.4||a;o(7.4.q!=3||B.q!=3){8 w}9 A=7.4;8 v.u([(A[1]*B[2])-(A[2]*B[1]),(A[2]*B[0])-(A[0]*B[2]),(A[0]*B[1])-(A[1]*B[0])])},2A:l(){9 m=0,n=7.4.q,k=n,i;J{i=k-n;o(F.13(7.4[i])>F.13(m)){m=7.4[i]}}H(--n);8 m},2Z:l(x){9 a=w,n=7.4.q,k=n,i;J{i=k-n;o(a===w&&7.4[i]==x){a=i+1}}H(--n);8 a},3g:l(){8 S.2X(7.4)},2d:l(){8 7.1b(l(x){8 F.2d(x)})},2V:l(x){8 7.1b(l(y){8(F.13(y-x)<=17.16)?x:y})},1o:l(a){o(a.K){8 a.1o(7)}9 V=a.4||a;o(V.q!=7.4.q){8 w}9 b=0,2b;7.28(l(x,i){2b=x-V[i-1];b+=2b*2b});8 F.1x(b)},3a:l(a){8 a.1h(7)},2T:l(a){8 a.1h(7)},1V:l(t,a){9 V,R,x,y,z;2S(7.4.q){27 2:V=a.4||a;o(V.q!=2){8 w}R=S.1R(t).4;x=7.4[0]-V[0];y=7.4[1]-V[1];8 v.u([V[0]+R[0][0]*x+R[0][1]*y,V[1]+R[1][0]*x+R[1][1]*y]);1I;27 3:o(!a.U){8 w}9 C=a.1r(7).4;R=S.1R(t,a.U).4;x=7.4[0]-C[0];y=7.4[1]-C[1];z=7.4[2]-C[2];8 v.u([C[0]+R[0][0]*x+R[0][1]*y+R[0][2]*z,C[1]+R[1][0]*x+R[1][1]*y+R[1][2]*z,C[2]+R[2][0]*x+R[2][1]*y+R[2][2]*z]);1I;2P:8 w}},1t:l(a){o(a.K){9 P=7.4.2O();9 C=a.1r(P).4;8 v.u([C[0]+(C[0]-P[0]),C[1]+(C[1]-P[1]),C[2]+(C[2]-(P[2]||0))])}1d{9 Q=a.4||a;o(7.4.q!=Q.q){8 w}8 7.1b(l(x,i){8 Q[i-1]+(Q[i-1]-x)})}},1N:l(){9 V=7.1q();2S(V.4.q){27 3:1I;27 2:V.4.19(0);1I;2P:8 w}8 V},2n:l(){8'['+7.4.2K(', ')+']'},26:l(a){7.4=(a.4||a).2O();8 7}};v.u=l(a){9 V=25 v();8 V.26(a)};v.i=v.u([1,0,0]);v.j=v.u([0,1,0]);v.k=v.u([0,0,1]);v.2J=l(n){9 a=[];J{a.19(F.2F())}H(--n);8 v.u(a)};v.1j=l(n){9 a=[];J{a.19(0)}H(--n);8 v.u(a)};l S(){}S.23={e:l(i,j){o(i<1||i>7.4.q||j<1||j>7.4[0].q){8 w}8 7.4[i-1][j-1]},33:l(i){o(i>7.4.q){8 w}8 v.u(7.4[i-1])},2E:l(j){o(j>7.4[0].q){8 w}9 a=[],n=7.4.q,k=n,i;J{i=k-n;a.19(7.4[i][j-1])}H(--n);8 v.u(a)},2R:l(){8{2D:7.4.q,1p:7.4[0].q}},2D:l(){8 7.4.q},1p:l(){8 7.4[0].q},24:l(a){9 M=a.4||a;o(1g(M[0][0])=='1f'){M=S.u(M).4}o(7.4.q!=M.q||7.4[0].q!=M[0].q){8 1L}9 b=7.4.q,15=b,i,G,10=7.4[0].q,j;J{i=15-b;G=10;J{j=10-G;o(F.13(7.4[i][j]-M[i][j])>17.16){8 1L}}H(--G)}H(--b);8 2x},1q:l(){8 S.u(7.4)},1b:l(a){9 b=[],12=7.4.q,15=12,i,G,10=7.4[0].q,j;J{i=15-12;G=10;b[i]=[];J{j=10-G;b[i][j]=a(7.4[i][j],i+1,j+1)}H(--G)}H(--12);8 S.u(b)},2i:l(a){9 M=a.4||a;o(1g(M[0][0])=='1f'){M=S.u(M).4}8(7.4.q==M.q&&7.4[0].q==M[0].q)},2j:l(a){9 M=a.4||a;o(1g(M[0][0])=='1f'){M=S.u(M).4}o(!7.2i(M)){8 w}8 7.1b(l(x,i,j){8 x+M[i-1][j-1]})},2C:l(a){9 M=a.4||a;o(1g(M[0][0])=='1f'){M=S.u(M).4}o(!7.2i(M)){8 w}8 7.1b(l(x,i,j){8 x-M[i-1][j-1]})},2B:l(a){9 M=a.4||a;o(1g(M[0][0])=='1f'){M=S.u(M).4}8(7.4[0].q==M.q)},22:l(a){o(!a.4){8 7.1b(l(x){8 x*a})}9 b=a.1u?2x:1L;9 M=a.4||a;o(1g(M[0][0])=='1f'){M=S.u(M).4}o(!7.2B(M)){8 w}9 d=7.4.q,15=d,i,G,10=M[0].q,j;9 e=7.4[0].q,4=[],21,20,c;J{i=15-d;4[i]=[];G=10;J{j=10-G;21=0;20=e;J{c=e-20;21+=7.4[i][c]*M[c][j]}H(--20);4[i][j]=21}H(--G)}H(--d);9 M=S.u(4);8 b?M.2E(1):M},x:l(a){8 7.22(a)},32:l(a,b,c,d){9 e=[],12=c,i,G,j;9 f=7.4.q,1p=7.4[0].q;J{i=c-12;e[i]=[];G=d;J{j=d-G;e[i][j]=7.4[(a+i-1)%f][(b+j-1)%1p]}H(--G)}H(--12);8 S.u(e)},31:l(){9 a=7.4.q,1p=7.4[0].q;9 b=[],12=1p,i,G,j;J{i=1p-12;b[i]=[];G=a;J{j=a-G;b[i][j]=7.4[j][i]}H(--G)}H(--12);8 S.u(b)},1y:l(){8(7.4.q==7.4[0].q)},2A:l(){9 m=0,12=7.4.q,15=12,i,G,10=7.4[0].q,j;J{i=15-12;G=10;J{j=10-G;o(F.13(7.4[i][j])>F.13(m)){m=7.4[i][j]}}H(--G)}H(--12);8 m},2Z:l(x){9 a=w,12=7.4.q,15=12,i,G,10=7.4[0].q,j;J{i=15-12;G=10;J{j=10-G;o(7.4[i][j]==x){8{i:i+1,j:j+1}}}H(--G)}H(--12);8 w},30:l(){o(!7.1y){8 w}9 a=[],n=7.4.q,k=n,i;J{i=k-n;a.19(7.4[i][i])}H(--n);8 v.u(a)},1K:l(){9 M=7.1q(),1c;9 n=7.4.q,k=n,i,1s,1n=7.4[0].q,p;J{i=k-n;o(M.4[i][i]==0){2e(j=i+1;j<k;j++){o(M.4[j][i]!=0){1c=[];1s=1n;J{p=1n-1s;1c.19(M.4[i][p]+M.4[j][p])}H(--1s);M.4[i]=1c;1I}}}o(M.4[i][i]!=0){2e(j=i+1;j<k;j++){9 a=M.4[j][i]/M.4[i][i];1c=[];1s=1n;J{p=1n-1s;1c.19(p<=i?0:M.4[j][p]-M.4[i][p]*a)}H(--1s);M.4[j]=1c}}}H(--n);8 M},3h:l(){8 7.1K()},2z:l(){o(!7.1y()){8 w}9 M=7.1K();9 a=M.4[0][0],n=M.4.q-1,k=n,i;J{i=k-n+1;a=a*M.4[i][i]}H(--n);8 a},3f:l(){8 7.2z()},2y:l(){8(7.1y()&&7.2z()===0)},2Y:l(){o(!7.1y()){8 w}9 a=7.4[0][0],n=7.4.q-1,k=n,i;J{i=k-n+1;a+=7.4[i][i]}H(--n);8 a},3e:l(){8 7.2Y()},1Y:l(){9 M=7.1K(),1Y=0;9 a=7.4.q,15=a,i,G,10=7.4[0].q,j;J{i=15-a;G=10;J{j=10-G;o(F.13(M.4[i][j])>17.16){1Y++;1I}}H(--G)}H(--a);8 1Y},3d:l(){8 7.1Y()},2W:l(a){9 M=a.4||a;o(1g(M[0][0])=='1f'){M=S.u(M).4}9 T=7.1q(),1p=T.4[0].q;9 b=T.4.q,15=b,i,G,10=M[0].q,j;o(b!=M.q){8 w}J{i=15-b;G=10;J{j=10-G;T.4[i][1p+j]=M[i][j]}H(--G)}H(--b);8 T},2w:l(){o(!7.1y()||7.2y()){8 w}9 a=7.4.q,15=a,i,j;9 M=7.2W(S.I(a)).1K();9 b,1n=M.4[0].q,p,1c,2v;9 c=[],2c;J{i=a-1;1c=[];b=1n;c[i]=[];2v=M.4[i][i];J{p=1n-b;2c=M.4[i][p]/2v;1c.19(2c);o(p>=15){c[i].19(2c)}}H(--b);M.4[i]=1c;2e(j=0;j<i;j++){1c=[];b=1n;J{p=1n-b;1c.19(M.4[j][p]-M.4[i][p]*M.4[j][i])}H(--b);M.4[j]=1c}}H(--a);8 S.u(c)},3c:l(){8 7.2w()},2d:l(){8 7.1b(l(x){8 F.2d(x)})},2V:l(x){8 7.1b(l(p){8(F.13(p-x)<=17.16)?x:p})},2n:l(){9 a=[];9 n=7.4.q,k=n,i;J{i=k-n;a.19(v.u(7.4[i]).2n())}H(--n);8 a.2K('\\n')},26:l(a){9 i,4=a.4||a;o(1g(4[0][0])!='1f'){9 b=4.q,15=b,G,10,j;7.4=[];J{i=15-b;G=4[i].q;10=G;7.4[i]=[];J{j=10-G;7.4[i][j]=4[i][j]}H(--G)}H(--b);8 7}9 n=4.q,k=n;7.4=[];J{i=k-n;7.4.19([4[i]])}H(--n);8 7}};S.u=l(a){9 M=25 S();8 M.26(a)};S.I=l(n){9 a=[],k=n,i,G,j;J{i=k-n;a[i]=[];G=k;J{j=k-G;a[i][j]=(i==j)?1:0}H(--G)}H(--n);8 S.u(a)};S.2X=l(a){9 n=a.q,k=n,i;9 M=S.I(n);J{i=k-n;M.4[i][i]=a[i]}H(--n);8 M};S.1R=l(b,a){o(!a){8 S.u([[F.1H(b),-F.1G(b)],[F.1G(b),F.1H(b)]])}9 d=a.1q();o(d.4.q!=3){8 w}9 e=d.1u();9 x=d.4[0]/e,y=d.4[1]/e,z=d.4[2]/e;9 s=F.1G(b),c=F.1H(b),t=1-c;8 S.u([[t*x*x+c,t*x*y-s*z,t*x*z+s*y],[t*x*y+s*z,t*y*y+c,t*y*z-s*x],[t*x*z-s*y,t*y*z+s*x,t*z*z+c]])};S.3b=l(t){9 c=F.1H(t),s=F.1G(t);8 S.u([[1,0,0],[0,c,-s],[0,s,c]])};S.39=l(t){9 c=F.1H(t),s=F.1G(t);8 S.u([[c,0,s],[0,1,0],[-s,0,c]])};S.38=l(t){9 c=F.1H(t),s=F.1G(t);8 S.u([[c,-s,0],[s,c,0],[0,0,1]])};S.2J=l(n,m){8 S.1j(n,m).1b(l(){8 F.2F()})};S.1j=l(n,m){9 a=[],12=n,i,G,j;J{i=n-12;a[i]=[];G=m;J{j=m-G;a[i][j]=0}H(--G)}H(--12);8 S.u(a)};l 14(){}14.23={24:l(a){8(7.1m(a)&&7.1h(a.K))},1q:l(){8 14.u(7.K,7.U)},2U:l(a){9 V=a.4||a;8 14.u([7.K.4[0]+V[0],7.K.4[1]+V[1],7.K.4[2]+(V[2]||0)],7.U)},1m:l(a){o(a.W){8 a.1m(7)}9 b=7.U.1C(a.U);8(F.13(b)<=17.16||F.13(b-F.1A)<=17.16)},1o:l(a){o(a.W){8 a.1o(7)}o(a.U){o(7.1m(a)){8 7.1o(a.K)}9 N=7.U.2f(a.U).2q().4;9 A=7.K.4,B=a.K.4;8 F.13((A[0]-B[0])*N[0]+(A[1]-B[1])*N[1]+(A[2]-B[2])*N[2])}1d{9 P=a.4||a;9 A=7.K.4,D=7.U.4;9 b=P[0]-A[0],2a=P[1]-A[1],29=(P[2]||0)-A[2];9 c=F.1x(b*b+2a*2a+29*29);o(c===0)8 0;9 d=(b*D[0]+2a*D[1]+29*D[2])/c;9 e=1-d*d;8 F.13(c*F.1x(e<0?0:e))}},1h:l(a){9 b=7.1o(a);8(b!==w&&b<=17.16)},2T:l(a){8 a.1h(7)},1v:l(a){o(a.W){8 a.1v(7)}8(!7.1m(a)&&7.1o(a)<=17.16)},1U:l(a){o(a.W){8 a.1U(7)}o(!7.1v(a)){8 w}9 P=7.K.4,X=7.U.4,Q=a.K.4,Y=a.U.4;9 b=X[0],1z=X[1],1B=X[2],1T=Y[0],1S=Y[1],1M=Y[2];9 c=P[0]-Q[0],2s=P[1]-Q[1],2r=P[2]-Q[2];9 d=-b*c-1z*2s-1B*2r;9 e=1T*c+1S*2s+1M*2r;9 f=b*b+1z*1z+1B*1B;9 g=1T*1T+1S*1S+1M*1M;9 h=b*1T+1z*1S+1B*1M;9 k=(d*g/f+h*e)/(g-h*h);8 v.u([P[0]+k*b,P[1]+k*1z,P[2]+k*1B])},1r:l(a){o(a.U){o(7.1v(a)){8 7.1U(a)}o(7.1m(a)){8 w}9 D=7.U.4,E=a.U.4;9 b=D[0],1l=D[1],1k=D[2],1P=E[0],1O=E[1],1Q=E[2];9 x=(1k*1P-b*1Q),y=(b*1O-1l*1P),z=(1l*1Q-1k*1O);9 N=v.u([x*1Q-y*1O,y*1P-z*1Q,z*1O-x*1P]);9 P=11.u(a.K,N);8 P.1U(7)}1d{9 P=a.4||a;o(7.1h(P)){8 v.u(P)}9 A=7.K.4,D=7.U.4;9 b=D[0],1l=D[1],1k=D[2],1w=A[0],18=A[1],1a=A[2];9 x=b*(P[1]-18)-1l*(P[0]-1w),y=1l*((P[2]||0)-1a)-1k*(P[1]-18),z=1k*(P[0]-1w)-b*((P[2]||0)-1a);9 V=v.u([1l*x-1k*z,1k*y-b*x,b*z-1l*y]);9 k=7.1o(P)/V.1u();8 v.u([P[0]+V.4[0]*k,P[1]+V.4[1]*k,(P[2]||0)+V.4[2]*k])}},1V:l(t,a){o(1g(a.U)=='1f'){a=14.u(a.1N(),v.k)}9 R=S.1R(t,a.U).4;9 C=a.1r(7.K).4;9 A=7.K.4,D=7.U.4;9 b=C[0],1E=C[1],1J=C[2],1w=A[0],18=A[1],1a=A[2];9 x=1w-b,y=18-1E,z=1a-1J;8 14.u([b+R[0][0]*x+R[0][1]*y+R[0][2]*z,1E+R[1][0]*x+R[1][1]*y+R[1][2]*z,1J+R[2][0]*x+R[2][1]*y+R[2][2]*z],[R[0][0]*D[0]+R[0][1]*D[1]+R[0][2]*D[2],R[1][0]*D[0]+R[1][1]*D[1]+R[1][2]*D[2],R[2][0]*D[0]+R[2][1]*D[1]+R[2][2]*D[2]])},1t:l(a){o(a.W){9 A=7.K.4,D=7.U.4;9 b=A[0],18=A[1],1a=A[2],2N=D[0],1l=D[1],1k=D[2];9 c=7.K.1t(a).4;9 d=b+2N,2h=18+1l,2o=1a+1k;9 Q=a.1r([d,2h,2o]).4;9 e=[Q[0]+(Q[0]-d)-c[0],Q[1]+(Q[1]-2h)-c[1],Q[2]+(Q[2]-2o)-c[2]];8 14.u(c,e)}1d o(a.U){8 7.1V(F.1A,a)}1d{9 P=a.4||a;8 14.u(7.K.1t([P[0],P[1],(P[2]||0)]),7.U)}},1Z:l(a,b){a=v.u(a);b=v.u(b);o(a.4.q==2){a.4.19(0)}o(b.4.q==2){b.4.19(0)}o(a.4.q>3||b.4.q>3){8 w}9 c=b.1u();o(c===0){8 w}7.K=a;7.U=v.u([b.4[0]/c,b.4[1]/c,b.4[2]/c]);8 7}};14.u=l(a,b){9 L=25 14();8 L.1Z(a,b)};14.X=14.u(v.1j(3),v.i);14.Y=14.u(v.1j(3),v.j);14.Z=14.u(v.1j(3),v.k);l 11(){}11.23={24:l(a){8(7.1h(a.K)&&7.1m(a))},1q:l(){8 11.u(7.K,7.W)},2U:l(a){9 V=a.4||a;8 11.u([7.K.4[0]+V[0],7.K.4[1]+V[1],7.K.4[2]+(V[2]||0)],7.W)},1m:l(a){9 b;o(a.W){b=7.W.1C(a.W);8(F.13(b)<=17.16||F.13(F.1A-b)<=17.16)}1d o(a.U){8 7.W.2k(a.U)}8 w},2k:l(a){9 b=7.W.1C(a.W);8(F.13(F.1A/2-b)<=17.16)},1o:l(a){o(7.1v(a)||7.1h(a)){8 0}o(a.K){9 A=7.K.4,B=a.K.4,N=7.W.4;8 F.13((A[0]-B[0])*N[0]+(A[1]-B[1])*N[1]+(A[2]-B[2])*N[2])}1d{9 P=a.4||a;9 A=7.K.4,N=7.W.4;8 F.13((A[0]-P[0])*N[0]+(A[1]-P[1])*N[1]+(A[2]-(P[2]||0))*N[2])}},1h:l(a){o(a.W){8 w}o(a.U){8(7.1h(a.K)&&7.1h(a.K.2j(a.U)))}1d{9 P=a.4||a;9 A=7.K.4,N=7.W.4;9 b=F.13(N[0]*(A[0]-P[0])+N[1]*(A[1]-P[1])+N[2]*(A[2]-(P[2]||0)));8(b<=17.16)}},1v:l(a){o(1g(a.U)=='1f'&&1g(a.W)=='1f'){8 w}8!7.1m(a)},1U:l(a){o(!7.1v(a)){8 w}o(a.U){9 A=a.K.4,D=a.U.4,P=7.K.4,N=7.W.4;9 b=(N[0]*(P[0]-A[0])+N[1]*(P[1]-A[1])+N[2]*(P[2]-A[2]))/(N[0]*D[0]+N[1]*D[1]+N[2]*D[2]);8 v.u([A[0]+D[0]*b,A[1]+D[1]*b,A[2]+D[2]*b])}1d o(a.W){9 c=7.W.2f(a.W).2q();9 N=7.W.4,A=7.K.4,O=a.W.4,B=a.K.4;9 d=S.1j(2,2),i=0;H(d.2y()){i++;d=S.u([[N[i%3],N[(i+1)%3]],[O[i%3],O[(i+1)%3]]])}9 e=d.2w().4;9 x=N[0]*A[0]+N[1]*A[1]+N[2]*A[2];9 y=O[0]*B[0]+O[1]*B[1]+O[2]*B[2];9 f=[e[0][0]*x+e[0][1]*y,e[1][0]*x+e[1][1]*y];9 g=[];2e(9 j=1;j<=3;j++){g.19((i==j)?0:f[(j+(5-i)%3)%3])}8 14.u(g,c)}},1r:l(a){9 P=a.4||a;9 A=7.K.4,N=7.W.4;9 b=(A[0]-P[0])*N[0]+(A[1]-P[1])*N[1]+(A[2]-(P[2]||0))*N[2];8 v.u([P[0]+N[0]*b,P[1]+N[1]*b,(P[2]||0)+N[2]*b])},1V:l(t,a){9 R=S.1R(t,a.U).4;9 C=a.1r(7.K).4;9 A=7.K.4,N=7.W.4;9 b=C[0],1E=C[1],1J=C[2],1w=A[0],18=A[1],1a=A[2];9 x=1w-b,y=18-1E,z=1a-1J;8 11.u([b+R[0][0]*x+R[0][1]*y+R[0][2]*z,1E+R[1][0]*x+R[1][1]*y+R[1][2]*z,1J+R[2][0]*x+R[2][1]*y+R[2][2]*z],[R[0][0]*N[0]+R[0][1]*N[1]+R[0][2]*N[2],R[1][0]*N[0]+R[1][1]*N[1]+R[1][2]*N[2],R[2][0]*N[0]+R[2][1]*N[1]+R[2][2]*N[2]])},1t:l(a){o(a.W){9 A=7.K.4,N=7.W.4;9 b=A[0],18=A[1],1a=A[2],2M=N[0],2L=N[1],2Q=N[2];9 c=7.K.1t(a).4;9 d=b+2M,2p=18+2L,2m=1a+2Q;9 Q=a.1r([d,2p,2m]).4;9 e=[Q[0]+(Q[0]-d)-c[0],Q[1]+(Q[1]-2p)-c[1],Q[2]+(Q[2]-2m)-c[2]];8 11.u(c,e)}1d o(a.U){8 7.1V(F.1A,a)}1d{9 P=a.4||a;8 11.u(7.K.1t([P[0],P[1],(P[2]||0)]),7.W)}},1Z:l(a,b,c){a=v.u(a);a=a.1N();o(a===w){8 w}b=v.u(b);b=b.1N();o(b===w){8 w}o(1g(c)=='1f'){c=w}1d{c=v.u(c);c=c.1N();o(c===w){8 w}}9 d=a.4[0],18=a.4[1],1a=a.4[2];9 e=b.4[0],1W=b.4[1],1X=b.4[2];9 f,1i;o(c!==w){9 g=c.4[0],2l=c.4[1],2t=c.4[2];f=v.u([(1W-18)*(2t-1a)-(1X-1a)*(2l-18),(1X-1a)*(g-d)-(e-d)*(2t-1a),(e-d)*(2l-18)-(1W-18)*(g-d)]);1i=f.1u();o(1i===0){8 w}f=v.u([f.4[0]/1i,f.4[1]/1i,f.4[2]/1i])}1d{1i=F.1x(e*e+1W*1W+1X*1X);o(1i===0){8 w}f=v.u([b.4[0]/1i,b.4[1]/1i,b.4[2]/1i])}7.K=a;7.W=f;8 7}};11.u=l(a,b,c){9 P=25 11();8 P.1Z(a,b,c)};11.2I=11.u(v.1j(3),v.k);11.2H=11.u(v.1j(3),v.i);11.2G=11.u(v.1j(3),v.j);11.36=11.2I;11.35=11.2H;11.3j=11.2G;9 $V=v.u;9 $M=S.u;9 $L=14.u;9 $P=11.u;",62,206,"||||elements|||this|return|var||||||||||||function|||if||length||||create|Vector|null|||||||||Math|nj|while||do|anchor||||||||Matrix||direction||normal||||kj|Plane|ni|abs|Line|ki|precision|Sylvester|A2|push|A3|map|els|else||undefined|typeof|contains|mod|Zero|D3|D2|isParallelTo|kp|distanceFrom|cols|dup|pointClosestTo|np|reflectionIn|modulus|intersects|A1|sqrt|isSquare|X2|PI|X3|angleFrom|mod1|C2|mod2|sin|cos|break|C3|toRightTriangular|false|Y3|to3D|E2|E1|E3|Rotation|Y2|Y1|intersectionWith|rotate|v12|v13|rank|setVectors|nc|sum|multiply|prototype|eql|new|setElements|case|each|PA3|PA2|part|new_element|round|for|cross|product|AD2|isSameSizeAs|add|isPerpendicularTo|v22|AN3|inspect|AD3|AN2|toUnitVector|PsubQ3|PsubQ2|v23|dot|divisor|inverse|true|isSingular|determinant|max|canMultiplyFromLeft|subtract|rows|col|random|ZX|YZ|XY|Random|join|N2|N1|D1|slice|default|N3|dimensions|switch|liesIn|translate|snapTo|augment|Diagonal|trace|indexOf|diagonal|transpose|minor|row|isAntiparallelTo|ZY|YX|acos|RotationZ|RotationY|liesOn|RotationX|inv|rk|tr|det|toDiagonalMatrix|toUpperTriangular|version|XZ".split("|"),0,{})),window.console||(window.console={},window.console.log=window.console.info=window.console.dir=function(){});
var MapEditor={},ME=MapEditor;ME.Class=L.Class,ME.LatLng=L.LatLng,ME.LatLngBounds=L.LatLngBounds,ME.Point=L.Point,ME.Bounds=L.Bounds,ME.Icon=L.Icon,ME.DivIcon=L.DivIcon,ME.LayerGroup=L.LayerGroup,ME.FeatureGroup=L.FeatureGroup,ME.GeoJSON=L.GeoJSON,ME.Popup=L.Popup,ME.Control=L.Control,ME.control=L.control,ME.Util=L.Util,ME.extend=L.Util.extend,ME.bind=L.Util.bind,ME.stamp=L.Util.stamp,ME.setOptions=L.Util.setOptions,ME.Browser=L.Util.Browser,ME.LineUtil=L.Util.LineUtil,ME.PolyUtil=L.Util.PolyUtil,ME.Transformation=L.Util.Transformation,ME.DomEvent=L.DomEvent,ME.DomUtil=L.DomUtil,ME.PosAnimation=L.PosAnimation,ME.Draggable=L.Draggable,ME.TileLayer=L.TileLayer,ME.Handler=L.Handler,L.Icon.Default.imagePath="../images",ME.Util=ME.Util||{},function(a){Hash=function(){},Hash.prototype={constructor:Hash,add:function(a,b){this.hasOwnProperty(a)||(this[a]=b)},remove:function(a){this.hasOwnProperty(a)&&delete this[a]},update:function(a,b){this[a]=b},has:function(a){var b=typeof a;return"string"===b||"number"===b?this.hasOwnProperty(a):"function"===b&&this.some(a)?!0:!1},clear:function(){for(var a in this)this.hasOwnProperty(a)&&delete this[a]},empty:function(){for(var a in this)if(this.hasOwnProperty(a))return!1;return!0},each:function(a){for(var b in this)this.hasOwnProperty(b)&&a.call(this,this[b],b,this)},map:function(a){var b=new Hash;for(var c in this)this.hasOwnProperty(c)&&b.add(c,a.call(this,this[c],c,this));return b},filter:function(){new Hash;for(var a in this);},join:function(a){a=void 0!==a?a:",";var b=[];return this.each(function(a){b.push(a)}),b.join(a)},every:function(a){for(var b in this)if(this.hasOwnProperty(b)&&!a.call(this,this[b],b,this))return!1;return!0},some:function(a){for(var b in this)if(this.hasOwnProperty(b)&&a.call(this,this[b],b,this))return!0;return!1},find:function(a){var b=typeof a;if("string"===b||"number"===b&&this.has(a))return this[a];if("function"===b)for(var c in this)if(this.hasOwnProperty(c)&&a.call(this,this[c],c,this))return this[c];return null}},a.Hash=Hash}(MapEditor),ME.Util.DataToLayers=function(a,b,c){var d={1:function(a){var b,d=a.node||[];d.forEach(function(a){b=new ME.Marker({id:a.id,latlng:L.latLng(a.lat,a.lon),data:a}),c&&"function"==typeof c&&c(b)})},2:function(a){var b,d=a.node||[],e=a.way||[],f=[];e.forEach(function(a){var e=a.nd[0][0];f=e.map(function(a){var b=d.filter(function(b){return b.id==a.ref})[0];return L.latLng(b.lat,b.lon)}),b=new ME.Polyline({id:a.id,latlngs:f,data:a}),c&&"function"==typeof c&&c(b)})},3:function(a){var b,d=a.node||[],e=a.way||[],f=[];e.forEach(function(a){var e=a.nd[0][0];f=e.map(function(a){var b=d.filter(function(b){return b.id==a.ref})[0];return L.latLng(b.lat,b.lon)}),b=new ME.Polygon({id:a.id,latlngs:f,data:a}),c&&"function"==typeof c&&c(b)})}};d[a](b)},ME.Draw={},function(a){a.Draw.Polyline=L.Draw.Polyline.extend({statics:{TYPE:"polyline"},options:{closable:!0},Poly:L.Polyline,addHooks:function(){L.Draw.Feature.prototype.addHooks.call(this),this._map&&(this._markers=[],this._markerGroup=new L.LayerGroup,this._map.addLayer(this._markerGroup),this._poly=new a.Polyline({latlngs:[],options:this.options.shapeOptions}),this._tooltip.updateContent(this._getTooltipText()),this._mouseMarker||(this._mouseMarker=L.marker(this._map.getCenter(),{icon:L.divIcon({className:"leaflet-mouse-marker",iconAnchor:[20,20],iconSize:[40,40]}),opacity:0,zIndexOffset:this.options.zIndexOffset})),this._mouseMarker.on("click",this._onClick,this).addTo(this._map),this._map.on("mousemove",this._onMouseMove,this).on("zoomend",this._onZoomEnd,this))},removeHooks:function(){L.Draw.Feature.prototype.removeHooks.call(this),this._clearHideErrorTimeout(),this._cleanUpShape(),this._map.removeLayer(this._markerGroup),delete this._markerGroup,delete this._markers,this._map.removeLayer(this._poly),delete this._poly,this._mouseMarker.off("click",this._onClick,this),this._map.removeLayer(this._mouseMarker),delete this._mouseMarker,this._clearGuides(),this._map.off("mousemove",this._onMouseMove,this).off("zoomend",this._onZoomEnd,this)},_onClick:function(a){var b=a.target.getLatLng();this.addVertex(b)},_createMarker:function(b){var c=new a.Marker({latlng:b,options:{icon:this.options.icon,zIndexOffset:2*this.options.zIndexOffset}});return this._markerGroup.addLayer(c),c},_fireCreatedEvent:function(){var b,c="polygon"===this.type?"Polygon":"Polyline";b=new a[c]({latlngs:this._poly.getLatLngs(),options:this.options.shapeOptions}),L.Draw.Feature.prototype._fireCreatedEvent.call(this,b),this.options.shapeOptions.closed=!1,this._map.changes.fire("created",{layer:b})},_vertexChanged:function(a,b){L.Draw.Polyline.prototype._vertexChanged.call(this,a,b),this.options.closable&&this._updateClosableHandler()},_updateClosableHandler:function(){var a=this._markers.length;a>2?this._markers[0].on("click",this._closePolyline,this):this._markers[0].off("click",this._closePolyline,this)},_closePolyline:function(){L.setOptions(this._poly,{closed:!0}),this.options.shapeOptions.closed=!0,this._poly.redraw(),this._finishShape()},_cleanUpShape:function(){L.Draw.Polyline.prototype._cleanUpShape.call(this),this._markers.length&&this._markers[0].off("click",this._closePolyline,this)}})}(MapEditor),ME.Draw.AssistLine=L.Draw.Polyline.extend({initialize:function(a,b){L.Draw.Polyline.prototype.initialize.call(this,a,b),this.type="assistline"},addHooks:function(){L.Draw.Polyline.prototype.addHooks.call(this),this._poly=new ME.Entity.AssistLine([],this.options.shapeOptions)},_fireCreatedEvent:function(){var a=new ME.Entity.AssistLine(this._poly.getLatLngs(),this.options.shapeOptions);L.Draw.Feature.prototype._fireCreatedEvent.call(this,a)}}),ME.Draw.AssistPolygon=L.Draw.Polygon.extend({initialize:function(a,b){L.Draw.Polygon.prototype.initialize.call(this,a,b),this.type="assistpolygon"},addHooks:function(){L.Draw.Polygon.prototype.addHooks.call(this),this._poly=new ME.Entity.AssistPolygon([],this.options.shapeOptions)},_fireCreatedEvent:function(){var a=new ME.Entity.AssistPolygon(this._poly.getLatLngs(),this.options.shapeOptions);L.Draw.Feature.prototype._fireCreatedEvent.call(this,a)}}),ME.Draw.AssistMarker=L.Draw.Marker.extend({initialize:function(a,b){L.Draw.Marker.prototype.initialize.call(this,a,b),this.type="assistmarker"},addHooks:function(){L.Draw.Marker.prototype.addHooks.call(this)},_fireCreatedEvent:function(){var a=new ME.Entity.AssistMarker(this._marker.getLatLng(),{icon:this.options.icon});L.Draw.Feature.prototype._fireCreatedEvent.call(this,a)}}),function(a){a.Draw.Polygon=L.Draw.Polygon.extend({includes:L.Draw.Polygon.prototype,statics:{TYPE:"polygon"},Poly:L.Polygon,options:{showArea:!1,shapeOptions:{stroke:!0,color:"#f06eaa",weight:4,opacity:.5,fill:!0,fillColor:null,fillOpacity:.2,clickable:!0}},initialize:function(a,b){L.Draw.Polygon.prototype.initialize.call(this,a,b)},addHooks:function(){L.Draw.Feature.prototype.addHooks.call(this),this._map&&(this._markers=[],this._markerGroup=new L.LayerGroup,this._map.addLayer(this._markerGroup),this._poly=new a.Polyline({latlngs:[],options:this.options.shapeOptions}),this._tooltip.updateContent(this._getTooltipText()),this._mouseMarker||(this._mouseMarker=L.marker(this._map.getCenter(),{icon:L.divIcon({className:"leaflet-mouse-marker",iconAnchor:[20,20],iconSize:[40,40]}),opacity:0,zIndexOffset:this.options.zIndexOffset})),this._mouseMarker.on("click",this._onClick,this).addTo(this._map),this._map.on("mousemove",this._onMouseMove,this).on("zoomend",this._onZoomEnd,this))},removeHooks:function(){L.Draw.Feature.prototype.removeHooks.call(this),this._clearHideErrorTimeout(),this._cleanUpShape(),this._map.removeLayer(this._markerGroup),delete this._markerGroup,delete this._markers,this._map.removeLayer(this._poly),delete this._poly,this._mouseMarker.off("click",this._onClick,this),this._map.removeLayer(this._mouseMarker),delete this._mouseMarker,this._clearGuides(),this._map.off("mousemove",this._onMouseMove,this).off("zoomend",this._onZoomEnd,this)},_onClick:function(a){var b=a.target.getLatLng();this.addVertex(b)},_createMarker:function(b){var c=new a.Marker({latlng:b,options:{icon:this.options.icon,zIndexOffset:2*this.options.zIndexOffset}});return this._markerGroup.addLayer(c),c},_fireCreatedEvent:function(){var b,c="polygon"===this.type?"Polygon":"Polyline";b=new a[c]({latlngs:this._poly.getLatLngs(),options:this.options.shapeOptions}),L.Draw.Feature.prototype._fireCreatedEvent.call(this,b),this._map.changes.fire("created",{layer:b})}})}(MapEditor),ME.Draw.Marker=L.Draw.Marker.extend({statics:{TYPE:"marker"},options:{icon:new L.Icon.Default,repeatMode:!1,draggable:!0,zIndexOffset:2e3},initialize:function(a,b){L.Draw.Marker.prototype.initialize.call(this,a,b)},_fireCreatedEvent:function(){var a=this,b=new ME.Marker({latlng:this._marker.getLatLng(),options:{icon:this.options.icon,draggable:this.options.draggable}});this._map.changes.fire("created",{layer:b}),b.on("dragend",function(){a._map.changes.fire("created",{layer:b})}),L.Draw.Feature.prototype._fireCreatedEvent.call(this,b)}}),function(a){a.Map=L.Map.extend({initialize:function(b,c,d){d=d||{},c=c||{},d=L.extend({minZoom:1,maxZoom:18,subdomains:"123"},d);var e=a.Config,f=this,g=e.map.tileUrlTemplate,h=new L.TileLayer(g,d);c.layers||(c.layers=[h]),L.Map.prototype.initialize.call(this,b,c),this.changes=new a.Changes,this.toolbars=new a.Hash,this.openedGroup=new a.Hash,this.on("dragend zoomend",function(){f.openedGroup.each(function(a){a.openning&&a.loadLayers.call(a)})})},addGroup:function(b){L.Map.prototype.addLayer.call(this,b),b instanceof a.Group&&this.openedGroup.add(b._leaflet_id,b),this.fire("groupadd",{group:b})},removeGroup:function(b){b instanceof a.Group&&this.openedGroup.remove(b._leaflet_id),this.fire("groupremove",{group:b}),L.Map.prototype.removeLayer.call(this,b)},removeAllGroups:function(){var a=this;this.openedGroup.each(function(b,c){b.editDisable(),a.removeGroup(b),a.openedGroup.remove(c)})},addToolbar:function(a,b){L.Map.prototype.addControl.call(this,b),this.toolbars.add(a,b)},removeToolbar:function(a){if(a){var b=this.getToolbar(a);b&&(L.Map.prototype.removeControl.call(this,b),this.toolbars.remove(a))}},getToolbar:function(a){return this.toolbars.find(a)},getChanges:function(){return this.changes},clearChanges:function(){return this.changes.clear(),this},getMarkerByLatLng:function(a){var b=[];return this.eachLayer(function(c){"marker"===c.type&&c._latlng.equals(a)&&b.push(c)}),b[0]}})}(MapEditor),ME.Map.include({fitDistrict:function(a,b,c){var d=ME.Config.data.getDistrictBoundsUrl,e=new XHR({cross:!0,fla:!0}),f=this;e.getJSON(d,{paras:{province:encodeURI(a),city:encodeURI(b),county:encodeURI(c)}},function(a){var b,c=a.data.data;if(c&&c.length){c=c[0].bbox.split(";");var b=L.latLngBounds([c[1],c[0]],[c[3],c[2]]);f.fitBounds(b),f.fire("fitDistrictEnd",b)}})}}),ME.Handler={},ME.Handler.SelectRoad=L.Handler.extend({includes:L.Mixin.Events,options:{repeatMode:!0},addHooks:function(){this._map.on("click",this._getRoads,this),this._map._container.style.cursor="default",this.fire("enabled")},removeHooks:function(){this._map.off("click",this._getRoads,this),this._map._container.style.cursor="-webkit-grab",this.fire("disabled")},_getRoads:function(a){var b=this,c=(this.options.url,function(a){var c=(a.status,a.data);return c?(c=c.map(function(a){return a=a.split(";"),a=a.map(function(a){return a=a.split(","),new L.LatLng(a[1],a[0])})}),b._map.fire("draw:created",{roads:c,pathtype:"pointSelectRoad"}),b.disable(),void(b.options.repeatMode&&b.enable())):void alert("没有道路数据")});ME.Util.pointSelectRoad({url:ME.Config.data.selectRoadUrl,lng:a.latlng.lng,lat:a.latlng.lat},c,this)}}),ME.Handler.Delete=L.Handler.extend({initialize:function(a){L.Handler.prototype.initialize.call(this,a)},addHooks:function(){var a=this;this._map.editingGroup.eachLayer(function(b){b.on("contextmenu",a._removeLayerAction,a)})},removeHooks:function(){var a=this;this._map.editingGroup.eachLayer(function(b){b.off("contextmenu",a._removeLayerAction,a)})},_removeLayerAction:function(a){var b=a.target;L.DomEvent.stopPropagation(a),L.DomEvent.preventDefault(a),this._map.editingGroup.removeLayer(b),this._map.changes.fire("deleted",{layer:b})}}),ME.Handler.PathDraggable=L.Draggable.extend({initialize:function(a,b){this.path=a,b||(b=a._container),L.Draggable.prototype.initialize.apply(this,[a._container,b])},_onDown:function(a){var b,c=this.path,d=c.getBounds();this.path instanceof L.Path!=0&&(this._originalPoints=this._getOriginalPoints(),this.pathCenter=c._map.latLngToLayerPoint(d.getCenter()),this._moved=!1,a.shiftKey||a.ctrlKey||1!==a.which&&1!==a.button&&!a.touches||(L.DomEvent.stopPropagation(a),L.Draggable._disabled||(L.DomUtil.disableImageDrag(),L.DomUtil.disableTextSelection(),this._moving||(b=a.touches?a.touches[0]:a,this._startPoint=new L.Point(b.clientX,b.clientY),this._startPos=this._newPos=this._startPoint,L.DomEvent.on(document,L.Draggable.MOVE[a.type],this._onMove,this).on(document,L.Draggable.END[a.type],this._onUp,this),c._map.dragging.disable()))))},_onMove:function(a){var b,c,d;return a.touches&&a.touches.length>1?void(this._moved=!0):(b=a.touches&&1===a.touches.length?a.touches[0]:a,c=new L.Point(b.clientX,b.clientY),d=c.subtract(this._startPoint),this._newPos=c,void((d.x||d.y)&&(L.DomEvent.preventDefault(a),this._moved||(this._disableEdit(),this.path.fire("dragstart"),this._moved=!0,L.DomUtil.addClass(document.body,"leaflet-dragging"),L.DomUtil.addClass(a.target||a.srcElement,"leaflet-drag-target")),this._latlngs=this._transform(this._startPoint,c),this._moving=!0,L.Util.cancelAnimFrame(this._animRequest),this._animRequest=L.Util.requestAnimFrame(this._updatePosition,this,!0,this._dragStartTarget))))},_updatePosition:function(){this.fire("predrag"),this.path.setLatLngs(this._latlngs),this.path.fire("drag")},_onUp:function(a){this.path._map.dragging.enable(),this._enableEdit(),L.Draggable.prototype._onUp.apply(this,[a]),this.path.fire("dragend")},_transform:function(){},moved:function(){return this._moved},_disableEdit:function(){0!=this.path.editing.enabled()&&this.path.editing.disable()},_enableEdit:function(){this.path.editing.enabled()||this.path.editing.enable()},enabled:function(){return this._enabled}}),ME.Handler.PolylineMoveable=ME.Handler.PathDraggable.extend({_transform:function(a,b){for(var c=b.subtract(a),d=this.path._map,e=this._originalPoints,f=[],g=0,h=e.length;h>g;g++)f.push(d.layerPointToLatLng(e[g].add(c)));return f},_getOriginalPoints:function(){return this.path.projectLatlngs(),this.path._originalPoints.slice(0)}}),L.Polyline.addInitHook(function(){this.dragging||this.on("add",function(){ME.Handler.PolylineMoveable&&this.options.draggable!==!1&&(this.dragging=new ME.Handler.PolylineMoveable(this))},this)}),ME.Handler.PolylineRotateable=ME.Handler.PathDraggable.extend({enable:function(){ME.Handler.PathDraggable.prototype.enable.apply(this)},disable:function(){ME.Handler.PathDraggable.prototype.disable.apply(this)},_updateCenter:function(){},_getOriginalPoints:function(){return this.path.projectLatlngs(),this.path._originalPoints.slice(0)},_transform:function(a,b){var c,d,e=this.path._map,f=this._originalPoints,g=[];a=e.containerPointToLayerPoint(a),b=e.containerPointToLayerPoint(b),d=this._getMatrix(a,b);for(var h=0,i=f.length;i>h;h++)c=d.x($V([f[h].x,f[h].y,1])),g.push(e.layerPointToLatLng(L.point(c.elements[0],c.elements[1])));return g},_getMatrix:function(a,b){var c,d,e,f=this.pathCenter;return c=$M([[1,0,-f.x],[0,1,-f.y],[0,0,1]]),d=c.x($V([a.x,a.y,1])),e=c.x($V([b.x,b.y,1])),c=$M([[1,0,f.x],[0,1,f.y],[0,0,1]]).x(Matrix.RotationZ(this._getAngle(d,e))).x(c)},_getAngle:function(a,b){var c=Math.atan2(a.elements[1],a.elements[0]),d=Math.atan2(b.elements[1],b.elements[0]);return d-c}}),L.Polyline.addInitHook(function(){this.on("add",function(){this.rotating||ME.Handler.PolylineRotateable&&this.options.rotateable!==!1&&(this.rotating=new ME.Handler.PolylineRotateable(this))},this)}),ME.Handler.CircleMoveable=ME.Handler.PathDraggable.extend({_transform:function(a,b){var c=b.subtract(a);map=this.path._map,originalPoints=this._originalPoints,latlngs=[];for(var d=0,e=originalPoints.length;e>d;d++)latlngs.push(map.layerPointToLatLng(originalPoints[d].add(c)));return latlngs},_getOriginalPoints:function(){return this.path.projectLatlngs(),[this.path._point]},_updatePosition:function(){this.fire("predrag"),this.path.setLatLng(this._latlngs[0]),this.path.fire("drag")}}),L.Circle.addInitHook(function(){this.on("add",function(){this.dragging||ME.Handler.CircleMoveable&&this.options.draggable!==!1&&(this.dragging=new ME.Handler.CircleMoveable(this))},this)}),L.Map.mergeOptions({dragSelect:!0}),L.Map.DragSelect=L.Handler.extend({includes:L.Mixin.Events,options:{className:"mapeditor-areaselectlayer-mask",repeatMode:!1},initialize:function(a){this._map=a,this._container=a._container,this._pane=a._panes.overlayPane,this._moved=!1},addHooks:function(){L.DomEvent.on(this._container,"mousedown",this._onMouseDown,this),L.DomEvent.on(document,"keydown",this._onKeyDown,this),L.DomEvent.on(document,"keyup",this._onKeyUp,this)},removeHooks:function(){L.DomEvent.off(this._container,"mousedown",this._onMouseDown),L.DomEvent.off(document,"keydown",this._onKeyDown),L.DomEvent.off(document,"keyup",this._onKeyUp),this._moved=!1},moved:function(){return this._moved},_onMouseDown:function(a){return this._moved=!1,!a.ctrlKey||1!==a.which&&1!==a.button?!1:(L.DomUtil.disableTextSelection(),L.DomUtil.disableImageDrag(),this._startLayerPoint=this._map.mouseEventToLayerPoint(a),void L.DomEvent.on(document,"mousemove",this._onMouseMove,this).on(document,"mouseup",this._onMouseUp,this))},_onMouseMove:function(a){this._moved||(this._box=L.DomUtil.create("div","mapeditor-areaselectlayer-mask",this._pane),L.DomUtil.setPosition(this._box,this._startLayerPoint),this._container.style.cursor="crosshair");var b=this._startLayerPoint,c=this._box,d=this._map.mouseEventToLayerPoint(a),e=d.subtract(b),f=new L.Point(Math.min(d.x,b.x),Math.min(d.y,b.y));L.DomUtil.setPosition(c,f),this._selecting(b,d),this._moved=!0,c.style.width=Math.max(0,Math.abs(e.x))+"px",c.style.height=Math.max(0,Math.abs(e.y))+"px"},_selecting:function(a,b){var c=L.bounds(a,b),d=this,e=this._map.editingGroup;e&&e.eachLayer(function(a){var b=a._leaflet_id,f=d._checkIntersection(c,a),g=e.selectedLayers.indexOf(b);f&&0>g?(e.selectedLayers.push(b),a.setState("select"),a.selected=!0):!f&&g>=0&&(e.selectedLayers.splice(g,1),a.setState("common"),a.selected=!1)})},_checkIntersection:function(a,b){var c,d=[],e=this;if("polyline"!=b.type&&"assistline"!=b.type)return!1;b.getLatLngs().forEach(function(a){d.push(e._map.latLngToLayerPoint(a))});for(var f=0,g=d.length-1;g>f;f++)if(c=L.bounds(d[f],d[f+1]),a.intersects(c))return!0;return!1},_finish:function(){this._box&&(this._pane.removeChild(this._box),this._container.style.cursor="",this._box=null),L.DomUtil.enableTextSelection(),L.DomUtil.enableImageDrag(),L.DomEvent.off(document,"mousemove",this._onMouseMove).off(document,"mouseup",this._onMouseUp)},_onMouseUp:function(){this._finish()},_onKeyDown:function(a){17===a.keyCode&&this._map.dragging.disable()},_onKeyUp:function(a){17===a.keyCode&&(this._map.dragging.enable(),this._finish())}}),L.Map.addInitHook("addHandler","dragSelect",L.Map.DragSelect),function(a){a.Connect=L.Class.extend({includes:L.Mixin.Events,initialize:function(a,b){b=b||{};var c=b.loadUrl||"",d=b.loadParas||null,e=b.saveUrl||"",f=b.saveParas||null;this.http=new XHR({cross:!0}),this.map=a,c&&d&&this.createLoad(c,d),e&&f&&this.createSave(e,f)},createLoad:function(a,b){var c=this,d=a,e=b;this.loadData=function(a){c.http.get(d,{paras:e},function(b){var d;return b=JSON.parse(b),(d=b.data)?(c.fire("dataload:success",{data:d}),void(a&&"function"==typeof a&&a(d.data.dataSet))):void c.fire("dataload:error",{data:d})})}},createSave:function(a,b){var c=this,d=a,e=b;this.saveData=function(a){this.http.post(d,{paras:e},function(b){b=JSON.parse(b);var d=b.data;return d?(c.fire("datasave:success",{data:d}),void(a&&"function"==typeof a&&a(d.gds.data))):void c.fire("datasave:error",{data:d},c)})}}})}(MapEditor),function(a){var b=L.Class.extend({includes:L.Mixin.Events,initialize:function(){var b=this;this.created=new a.Hash,this.modified=new a.Hash,this.deleted=new a.Hash,this.on("created",function(a){var c=a.layer,d=c._leaflet_id;b.created.update(d,c),console.log(b.toXML())}),this.on("modified",function(a){var c=a.layer,d=c._leaflet_id;/^-\d+$/.test(d)?b.created.update(d,c):b.modified.update(d,c),console.log(b.toXML())}),this.on("deleted",function(a){{var c=a.layer,d=c._leaflet_id;c.data}/^-\d+$/.test(d)?b.created.remove(d):(b.modified.remove(d),b.deleted.update(d,c)),console.log(b.toXML())})},clear:function(){this.created.clear(),this.modified.clear(),this.deleted.clear()},remove:function(a){this.created.remove(a),this.modified.remove(a),this.deleted.remove(a),console.log(this.toXML())},empty:function(){return this.created.empty()&&this.modified.empty()&&this.deleted.empty()},has:function(a){return this.created.has(a)||this.modified.has(a)||this.deleted.has(a)},toJSON:function(){return JSON.stringify({created:this.created,modified:this.modified,deleted:this.deleted})},toXML:function(){var a='<?xml version="1.0" encoding="UTF-8"?>',b=this.modified,c=this.created,d=this.deleted;return a+="<osmChange>",a+=c.empty()?"<create/>":"<create>"+this.created.map(function(a){return a.toXML()}).join("")+"</create>",a+=b.empty()?"<modify/>":"<modify>"+this.modified.map(function(a){return a.toXML()}).join("")+"</modify>",a+=d.empty()?"<delete/>":"<delete>"+this.deleted.map(function(a){return a.toXML()}).join("")+"</delete>",a+="</osmChange>"}});a.Changes=b}(MapEditor),ME.State=L.Class.extend({initialize:function(a){this.common=a&&a.common||{color:"blue",weight:3},this.hover=a&&a.hover||{color:"green",weight:5},this.select=a&&a.selected||{color:"red",weight:3}},set:function(a,b){this[a]=b}}),function(a){a.Group=L.FeatureGroup.extend({initialize:function(a){L.setOptions(this,a),a=a||{};var b=a.layers;L.LayerGroup.prototype.initialize.call(this,b),this.editing=a.editing===!0,this.opening=a.opening===!0,this.selectedLayers=[],this.connect=a.connect,this.on("click",function(a){console.log("click:",a.layer)})},onAdd:function(a){L.FeatureGroup.prototype.onAdd.call(this,a),this.editing&&this.editEnable(),this.opening&&this.connect&&this.loadLayers()},onRemove:function(a){this.close(),this.editDisable(),L.FeatureGroup.prototype.onRemove.call(this,a)},addTo:function(a){return L.FeatureGroup.prototype.addTo.call(this,a),a.openedGroup.add(this._leaflet_id,this),this},editEnable:function(){var a=this._map;return this.editing&&a&&a.editingGroup===this?this:(this.editing=!0,a&&(a.editingGroup=this,this.on("datalayer:add datalayer:remove",this._fireChanges,this),this.on("layeradd",this._fireLayerAdd,this),this.on("layerremove",this._fireLayerRemove,this),this.on("click",this._fireSelect,this),this.eachLayer(function(a){a.editEnable()}),this.fire("editEnable",{group:this})),this)},editDisable:function(){var a;return this.editing?(a=this._map,this.editing=!1,a&&(a.editingGroup=null,this.off("click",this._fireSelect,this),this.eachLayer(function(a){a.editDisable()}),this.off("datalayer:add datalayer:remove",this._fireChanges,this),this.off("layeradd",this._fireLayerAdd,this),this.off("layerremove",this._fireLayerRemove,this),this._offSelect.call(this),this.fire("editDisable",{group:this})),this):this},_fireLayerAdd:function(a){var b=a.layer;b.isFireEdit&&b.editEnable()},_fireLayerRemove:function(a){var b,c=a.layer;c.isFireEdit&&c.editDisable(),(b=this.selectedLayers.indexOf(c._leaflet_id))>-1&&this.selectedLayers.splice(b,1)},open:function(){return this.opening||!this._map?this:(this.opening=!0,this.fire("open",{group:this}),this)},close:function(){var a=this._map;return this.opening&&a?(this.opening=!1,this.fire("close",{group:this}),this):this},_fireSelect:function(a){var b,c=this,d=a.layer,e=d._leaflet_id;a.originalEvent.shiftKey?-1==this.selectedLayers.indexOf(e)?(this.selectedLayers.push(e),d.fire("selectIn")):(b=this.selectedLayers.indexOf(e),this.selectedLayers.splice(b,1),d.fire("selectOut")):-1==this.selectedLayers.indexOf(e)?(this.selectedLayers.forEach(function(a){c.getLayer(a).fire("selectOut")}),this.selectedLayers.length=0,this.selectedLayers.push(e),d.fire("selectIn")):(this.selectedLayers.forEach(function(a){var b=c.getLayer(a);b!==d&&b.fire("selectOut")}),this.selectedLayers=[e])},_offSelect:function(){var a=this;this.selectedLayers.forEach(function(b){var c=a.getLayer(b);c.fire("selectOut")})},clearSelectedLayers:function(a){a=a||{};var b=a.remove,c=this;this.selectedLayers.forEach(function(a){var d=c.getLayer(a);d.fire("selectOut"),b&&c.removeDataLayer(d)}),this.fire("clearSelectedLayers"),this.selectedLayers=[]},addLayers:function(a){var b=this;a.forEach(function(a){b.addLayer(a)})},addDataLayer:function(a){this.editing&&(L.FeatureGroup.prototype.addLayer.call(this,a),this.fire("datalayer:add",{layer:a}))},removeDataLayer:function(a){var b,c,d=this;this.editing&&("string"==typeof a&&(a=this.getLayer(a)),c=a.type,("polyline"==c||"polygon"==c)&&(b=a.editing._markers,b.forEach(function(a){d.fire("datalayer:remove",{layer:a},d)})),a.editDisable(),this.fire("datalayer:remove",{layer:a}),L.FeatureGroup.prototype.removeLayer.call(this,a))},loadLayers:function(){var a=this;return this.filterLayer.call(this),this.connect&&this.connect.loadData(function(b){a._renderLayers.call(a,b)}),this},saveLayers:function(){var a=this;return this.connect&&this.connect.saveData(function(){a._map.clearChanges(),a.clearSelectedLayers(),a.clearLayers(),a.loadLayers()}),this},_renderLayers:function(b){var c=b.geoType,d=this,e=this._map;this.geoType=c,this.updateDataSet(b),a.Util.DataToLayers(c,b,function(a){var b=a._leaflet_id;e.changes.deleted.has(b)||d.addLayer(a)})},updateDataSet:function(a){this.dataSet=a},filterLayer:function(){var a,b,c=this;this._map&&(a=this._map.getBounds(),b=this.getLayers()||[],b.forEach(function(b){var d=c.geoType&&("1"==c.geoType?a.contains(b.getLatLng()):a.intersects(b.getBounds())),e=b._leaflet_id;/^-\d+/.test(e)||d||c._map.changes.has(e)||c.removeLayer(b)}))},setConnect:function(a){return this.connect=a,this},getConnect:function(){return this.connect},_fireChanges:function(a){var b=a.type,c=a.layer,d=this._map;switch(b){case"datalayer:add":d.changes.fire("created",{layer:c});break;case"datalayer:remove":d.changes.fire("deleted",{layer:c})}}}),a.group=function(b){return new a.Group(b)}}(MapEditor),ME.Entity={},ME.Entity.EditBind={editEnable:function(){this.edited||(this.edited=!0,this.on("click",function(){console.log(111)}),this.editing&&this.editing.enable(),this.dragging.enable(),this.on("selectIn",this._fireSelect,this).on("mouseover",this._fireOver,this).on("mouseout",this._fireOut,this).on("selectOut",this._fireSelectOut,this))},editDisable:function(){this.edited&&(this.edited=!1,this.editing&&this.editing.disable(),this.dragging.disable(),this.off("selectIn",this._fireSelect,this).off("mouseover",this._fireOver,this).off("mouseout",this._fireOut,this).off("selectOut",this._fireSelectOut,this))},setState:function(a){this.setStyle(this.states[a])},_fireOut:function(){this.selected||this.setState("common")},_fireOver:function(){this.selected||this.setState("hover")},_fireSelect:function(){this.setState("select"),this.selected=!0},_fireSelectOut:function(){this.setState("common"),this.selected=!1}},ME.Entity.DataEditBind=L.extend({},ME.Entity.EditBind,{setData:function(a){this.data=a},getData:function(){return this.data},editEnable:function(){this.edited||(this.edited=!0,this.editing&&this.editing.enable(),this.on("selectIn",this._fireSelect,this).on("mouseover",this._fireOver,this).on("mouseout",this._fireOut,this).on("selectOut",this._fireSelectOut,this).on("edit",this._fireChanges,this),this.dragging.enable(),this.on("dragend",this._fireDragEnd,this))},editDisable:function(){this.edited&&(this.edited=!1,this.editing&&this.editing.disable(),this.off("selectIn",this._fireSelect,this).off("mouseover",this._fireOver,this).off("mouseout",this._fireOut,this).off("selectOut",this._fireSelectOut,this).off("edit",this._fireChanges,this),this.dragging.disable(),this.off("dragend",this._fireDragEnd,this))},_fireChanges:function(){var a=this;this._map.changes.fire(/^-\d+$/.test(this._leaflet_id)?"created":"modified",{layer:a})},_fireDragEnd:function(){var a,b=this,c=this.editing;a=c._markers,a.forEach(function(a){b._map.changes.fire(/^-\d+$/.test(a._leaflet_id)?"created":"modified",{layer:a})})}}),ME.Text=L.Class.extend({includes:[L.Mixin.Events],options:{color:"red",fontSize:"14px",fontFamily:"microsoft yahei",width:"350px"},initialize:function(a,b){"object"==typeof a&&(b=a,a=""),this._text=document.createTextNode(a),L.setOptions(this,b)},onAdd:function(a){this._poly=a;var b=this._poly._map;this._container||this._initElements(),this._textNode.appendChild(this._text),this._updatePosition(),this.fire("add"),b.on({viewreset:this._redraw,zoomend:this._updatePosition},this)},onRemove:function(a){this.fire("remove"),this._textNode.removeChild(this._text),a._map.off({viewreset:this._redraw,zoomend:this._updatePosition},this),this._poly=null},addTo:function(a){return a.addText(this),this},_createElement:function(a){return L.Path.prototype._createElement.call(this,a)},_initElements:function(){var a=L.Path.SVG;this._container=a?this._poly._container:this._poly._path,this._textNode=this._createElement(a?"text":"textbox"),this.options.className&&L.DomUtil.addClass(this._path,this.options.className),this._updateStyle(),this._container.appendChild(this._textNode)},setPosition:function(){this._updatePosition()},setStyle:function(a){return L.setOptions(this,a),this._container&&this._updateStyle(),this},_updatePosition:function(){var a=this._poly,b=a.getBounds(),c=a._map,d=c.latLngToLayerPoint(b.getCenter()),e=c.latLngToLayerPoint(b._northEast),f=c.latLngToLayerPoint(b._southWest);L.Path.SVG?(this._textNode.setAttribute("x",d.x),this._textNode.setAttribute("y",d.y)):(this._textNode.style.position="relative",this._textNode.style.top=.5*Math.abs(e.y-f.y)+"px",this._textNode.style.left=.5*Math.abs(e.x-f.x)+"px")},_updateStyle:function(){this._textNode.style.color=this.options.color,this._textNode.style.fontSize=this.options.fontSize,this._textNode.style.fontFamily=this.options.fontFamily},_updateText:function(){for(var a;a=this._textNode.firstChild;)this._textNode.removeChild(a);this._textNode.appendChild(this._text)},setText:function(a){this._text=document.createTextNode(a),this._updateText(),this._updateStyle()},_redraw:function(){this._updateText(),this._updatePosition()}}),ME.Entity.AssistLine=L.Polyline.extend({includes:ME.Entity.EditBind,initialize:function(a,b){var c;L.Polyline.prototype.initialize.call(this,a,b),b&&(c=b.isFireEdit),this.type="assistline",this.states=new ME.State,this.selected=!1,this.edited=!1,this.isFireEdit=c!==!1},toPolyline:function(){}}),ME.Entity.AssistPolygon=L.Polygon.extend({includes:ME.Entity.EditBind,initialize:function(a,b){var c;b&&(c=b.isFireEdit),L.Polygon.prototype.initialize.call(this,a,b),this.type="assistpolygon",this.states=new ME.State,this.selected=!1,this.edited=!1,this.isFireEdit=c!==!1},toPolygon:function(){}}),ME.Entity.AssistMarker=L.Marker.extend({includes:ME.Entity.EditBind,initialize:function(a,b){var c;L.Marker.prototype.initialize.call(this,a,b),b&&(c=b.isFireEdit),this.type="assistmarker",this.states=new ME.State,this.selected=!1,this.edited=!1,this.isFireEdit=c!==!1},setStyle:function(a){a=L.extend({},this.options,a),this.setIcon(a.icon),this.setOpacity(a.opacity)},toMarker:function(){}}),ME.Polygon=L.Polygon.extend({includes:ME.Entity.DataEditBind,options:{weight:3,fill:!0,contextmenu:!0,contextmenuWidth:140},initialize:function(a){var b,c,d,e,f,g,h=[];if(a&&(b=a.id,c=a.latlngs||[],d=a.options||{},e=a.data,f=a.isFireEdit,g=a.text),d=L.extend({},this.options,d),L.Polygon.prototype.initialize.call(this,c,d),this._initContextMenuItems(),this._leaflet_id=b||L.stamp(this),this.states=new ME.State,this.selected=!1,this.edited=!1,this.isFireEdit=f!==!1,this.textNode=new ME.Text("测试名称"),g&&this.textNode.setText(g),e?(this.data=e,h=e.nd[0][0]):(this._latlngs.length>0&&this._latlngs[0].equals(this._latlngs[this._latlngs.length-1])&&c.pop(),this.data={id:this._leaflet_id,version:"1",changeset:"1",nd:h,tag:[{k:"area",v:"yes"}]}),h.length>0){var i=h.length;
h[0].ref===h[i-1].ref&&h.pop()}this.type="polygon"},onAdd:function(a){var b=this;L.Polygon.prototype.onAdd.call(this,a),this.addText(),L.Path.SVG&&(this.on("dragstart",this.removeText,this),this.on("dragend",this.addText,this)),this.on("edit",function(){b.textNode.setPosition()})},onRemove:function(a){this.removeText(),L.Path.SVG&&(this.off("dragstart",this.removeText,this),this.off("dragend",this.addText,this)),L.Polygon.prototype.onRemove.call(this,a)},removeText:function(){this.textNode.onRemove(this)},addText:function(){this.textNode.onAdd(this)},_onMouseClick:function(a){var b=this.dragging&&this.dragging.moved(),c=this.rotating&&this.rotating.moved();b||c||this._map.dragging&&this._map.dragging.moved()||this._fireMouseEvent(a)},toXML:function(){var a,b,c=this.data,d=c.nd[0][0]||[],e=c.tag||[];return a="<way",a+=' id="'+this._leaflet_id+'"',a+=' version="'+c.version+'"',a+=' changeset="'+c.changeset+'">',d=d.map(function(a){return'<nd ref="'+a.ref+'" />'}),d.length>0&&d.push(d[0]),a+=d.join(""),b=e.map(function(a){var b=a.v||"",c=a.k;return'<tag k="'+c+'" v="'+b+'"/>'}),a+=b.join(""),a+"</way>"},setText:function(a){this.textNode.setText(a)},_initContextMenuItems:function(){var a=[{text:"置于顶端",callback:this.bringToFront,context:this},{text:"置于底端",callback:this.bringToBack,context:this}];L.setOptions(this,{contextmenuItems:a})}}),ME.Polyline=L.Polyline.extend({includes:ME.Entity.DataEditBind,options:{stroke:!0,color:"#0033ff",dashArray:null,lineCap:null,lineJoin:null,weight:3,opacity:.5,fill:!1,fillColor:null,fillOpacity:.2,clickable:!0,contextmenu:!0,textOptions:{stroke:!0,weight:1}},initialize:function(a){var b,c,d,e,f,g=[];if(a&&(b=a.id,c=a.latlngs,d=a.options||{},e=a.data,f=a.isFireEdit),d=L.extend({},this.options,d),L.Polyline.prototype.initialize.call(this,c,d),this.textOptions=L.extend({},this.options.textOptions),this._initContextMenuItems(),this._leaflet_id=b||L.stamp(this),this.states=new ME.State,this.selected=!1,this.edited=!1,this.isFireEdit=f!==!1,this.closed=d.closed||!1,this.data=e?e:{id:this._leaflet_id,version:"1",changeset:"1",nd:[],tag:[]},g.length>0){var h=g.length;g[0].ref===g[h-1].ref&&g.pop(),this.closed=!0}this.type="polyline"},onRemove:function(a){L.Browser.vml&&this._map.removeLayer(this._text),L.Polyline.prototype.onRemove.call(this,a)},toXML:function(){var a,b,c=this.data,d=c.nd[0][0],e=c.tag;return a="<way",a+=' id="'+this._leaflet_id+'"',a+=' version="'+c.version+'"',a+=' changeset="'+c.changeset+'">',d=d.map(function(a){return'<nd ref="'+a.ref+'" />'}),this.closed&&d.push(d[0]),a+=d.join(""),b=e.map(function(a){var b=a.v||"",c=a.k;return'<tag k="'+c+'" v="'+b+'"/>'}),a+=b.join(""),a+"</way>"},_onMouseClick:function(a){var b=this.dragging&&this.dragging.moved(),c=this.rotating&&this.rotating.moved();b||c||this._map.dragging&&this._map.dragging.moved()||this._fireMouseEvent(a)},_getPathPartStr:function(a){var b=L.Polyline.prototype._getPathPartStr.call(this,a);return this.closed===!0&&(b+=L.Browser.svg?"z":"x"),b},_updatePath:function(){L.Polyline.prototype._updatePath.call(this),this.setText()},setText:function(a){var b;a=this.textOptions.text=a||this.textOptions.text,this._text||this._initTextElement(),L.Browser.svg?(b=this._text.firstChild,b&&b.firstChild&&b.removeChild(b.firstChild),a&&b.appendChild(document.createTextNode(a))):(this._text._textPath.string=a,this._text.setLatLngs(this.getLatLngs()))},_initTextElement:function(){var a,b,c;c=this._path.getAttribute("id"),L.Browser.svg?(this._text=a=this._createElement("text"),b=this._createElement("textPath"),c||(c="leaflet-pathid"+L.stamp(this),this._path.setAttribute("id",c)),b.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href","#"+c),a.appendChild(b),this._container.appendChild(a)):(this._text=L.polyline(this.getLatLngs(),this.textOptions).addTo(this._map),this._text._textPath=b=this._createElement("textpath"),b.setAttribute("style","v-text-align:left;"),this._text._container.appendChild(b),this._text._path.textpathok=!0,b.on=!0)},_initContextMenuItems:function(){var a=[{text:"置于顶端",callback:this.bringToFront,context:this},{text:"置于底端",callback:this.bringToBack,context:this}];L.setOptions(this,{contextmenuItems:a})}}),ME.Marker=L.Marker.extend({includes:ME.Entity.DataEditBind,options:{icon:new L.Icon({iconUrl:"/mapeditor/images/2.png",iconRetinaUrl:"",iconSize:[22,32],iconAnchor:[24,30],popupAnchor:[-3,-76],shadowUrl:"",shadowRetinaUrl:""}),title:"",alt:"",clickable:!0,draggable:!1,keyboard:!0,zIndexOffset:0,opacity:1,riseOnHover:!1,riseOffset:250},initialize:function(a){var b,c,d,e,f;a&&(b=a.id,c=a.latlng,d=a.options,e=a.data,f=a.isFireEdit),"[object Array]"==Object.prototype.toString.call(c)&&(c=L.latLng(c[0],c[1])),L.Marker.prototype.initialize.call(this,c,d),this._leaflet_id=b||L.stamp(this),this.states=new ME.State({common:{icon:new L.Icon({iconUrl:"/mapeditor/images/4.png"})},hover:{icon:new L.Icon({iconUrl:"/mapeditor/images/5.png"})},select:{icon:new L.Icon({iconUrl:"/mapeditor/images/5.png"})}}),this.selected=!1,this.edited=!1,this.isFireEdit=f!==!1,this.data=e||{id:this._leaflet_id,lat:c.lat,lon:c.lng,version:"1",changeset:"1",tag:[]},this.type="marker"},setStyle:function(a){a=L.extend({},this.options,a),this.setIcon(a.icon),this.setOpacity(a.opacity)},_fireDragEnd:function(){this._map.changes.fire(/^-\d+$/.test(this._leaflet_id)?"created":"modified",{layer:this})},toXML:function(){var a,b=this.data,c=b.tag||[],d="<node";return d+=' id="'+this._leaflet_id+'"',d+=' lat="'+this._latlng.lat+'"',d+=' lon="'+this._latlng.lng+'"',d+=' version="'+b.version+'"',d+=' changeset="'+b.changeset+'" >',a=c.map(function(a){var b=a.v||"",c=a.k;return'<tag k="'+c+'" v="'+b+'"/>'}),d+=a.join(""),d+="</node>"}}),ME.HollowPolygon=L.Polyline.extend({options:{fill:!0,stroke:!1,noClip:!0},initialize:function(a,b){L.Polyline.prototype.initialize.call(this,a,b),this._initDonut(a)},onAdd:function(a){L.Polyline.prototype.onAdd.call(this,a),a.addLayer(this.outerPolyline),this.innerPolylines.forEach(function(b){a.addLayer(b)})},_initDonut:function(a){var b=a.slice(1);this.innerPolylines=this.innerPolylines||[],this._innerLatlngs=[],this._latlngs=this._outerLatlngs=this._convertLatLngs(a[0]),this.outerPolyline?this.outerPolyline.setLatLngs(this._outerLatlngs):(this.outerPolyline=new ME.Polyline({latlngs:this._outerLatlngs,options:{closed:!0,noClip:!0}}),this.outerPolyline.on("editing edit",this._editing,this));for(var c=0,d=b.length;d>c;c++)this._innerLatlngs.push(this._convertLatLngs(b[c])),this.innerPolylines[c]?this.innerPolylines[c].setLatLngs(this._innerLatlngs[c]):(this.innerPolylines[c]=new ME.Polyline({latlngs:this._innerLatlngs[c],options:{closed:!0,noClip:!0}}),this.innerPolylines[c].on("editing edit",this._editing,this))},_editing:function(){var a=[];a.push(this.outerPolyline.getLatLngs()),this.innerPolylines.forEach(function(b){a.push(b.getLatLngs())}),this.setLatLngs(a)},projectLatlngs:function(){L.Polyline.prototype.projectLatlngs.call(this),this._outerPoints=[],this._innerPoints=[];var a,b,c,d;for(a=0,b=this._outerLatlngs.length;b>a;a++)this._outerPoints[a]=this._map.latLngToLayerPoint(this._outerLatlngs[a]);for(a=0,b=this._innerLatlngs.length;b>a;a++)for(this._innerPoints[a]=[],c=0,d=this._innerLatlngs[a].length;d>c;c++)this._innerPoints[a][c]=this._map.latLngToLayerPoint(this._innerLatlngs[a][c])},setLatLngs:function(a){return this._initDonut(a),this.redraw()},_clipPoints:function(){var a=[];if(this._parts=this._innerPoints.concat([this._outerPoints]),!this.options.noClip){for(var b=0,c=this._parts.length;c>b;b++){var d=L.PolyUtil.clipPolygon(this._parts[b],this._map._pathViewport);d.length&&a.push(d)}this._parts=a}},_getPathPartStr:function(a){var b=L.Polyline.prototype._getPathPartStr.call(this,a);return b+(L.Browser.svg?"z":"x")},toXML:function(){}}),ME.Donut=L.FeatureGroup.extend({initialize:function(a,b){this.hollowPolygons=[];for(var c=0,d=a.length;d>c;c++)this.hollowPolygons.push(new ME.HollowPolygon(a[c],b));L.FeatureGroup.prototype.initialize.call(this,this.hollowPolygons),L.setOptions(this,b)},onAdd:function(a){L.FeatureGroup.prototype.onAdd.call(this,a)},toXML:function(){this.hollowPolygons.forEach(function(a){console.log(a)})}}),ME.Edit=ME.Edit||{},ME.Edit.Poly=L.Edit.Poly.extend({options:{icon:new L.DivIcon({iconSize:new L.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon"})},initialize:function(a,b){this._poly=a,L.setOptions(this,b)},addHooks:function(){var a=this._poly;a._map&&(a.on("marker:remove marker:add marker:modify",this._fireChanges,this),this._markerGroup||this._initMarkers(),a._map.addLayer(this._markerGroup))},removeHooks:function(){var a=this._poly;a._map&&(a._map.removeLayer(this._markerGroup),a.off("marker:remove marker:add marker:modify",this._fireChanges,this),delete this._markerGroup,delete this._markers)},_fireChanges:function(a){var b,c=(a.target,a.type),d=a.layer,e=(this._markers,this._poly),f=e._map;if(f)switch(b=f.changes,c){case"marker:remove":b.fire("deleted",{layer:d}).fire("modified",{layer:e});break;case"marker:add":b.fire("created",{layer:d});break;case"marker:modify":b.fire("modified",{layer:d})}},updateMarkers:function(){this._markerGroup.clearLayers(),this._initMarkers()},_initMarkers:function(){{var a=this._poly;a._map}this._markerGroup||(this._markerGroup=new L.LayerGroup),this._markers=[];var b,c,d,e,f=this._poly.data,g=[],h=this._poly._latlngs,i=!1;for(f&&f.nd[0]?i=!0:f.nd=[[[]]],g=f.nd[0][0],b=0,d=h.length;d>b;b++)e=this._createMarker(h[b],b,g[b]&&g[b].ref||null),e.on("click",this._onMarkerClick,this),this._markers.push(e),i||(g.push({ref:e._leaflet_id}),a.fire("marker:add",{layer:e}));var j,k;for(b=0,c=d-1;d>b;c=b++)(0!==b||L.Polygon&&this._poly instanceof L.Polygon)&&(j=this._markers[c],k=this._markers[b],this._createMiddleMarker(j,k),this._updatePrevNext(j,k))},_createMarker:function(a,b,c){var d=(this._poly._map,new ME.Marker({latlng:a,id:c,options:{draggable:!0,icon:this.options.icon}}));return d._origLatLng=a,d._index=b,d.on("drag",this._onMarkerDrag,this),d.on("dragend",this._onMarkerDragEnd,this),this._markerGroup.addLayer(d),d},_removeMarker:function(a){var b=a._index;this._markerGroup.removeLayer(a),this._markers.splice(b,1),this._poly.spliceLatLngs(b,1),this._poly.data.nd[0][0].splice(b,1),this._updateIndexes(b,-1),this._poly.fire("marker:remove",{layer:a}),a.off("drag",this._onMarkerDrag,this).off("dragend",this._onMarkerDragEnd,this).off("click",this._onMarkerClick,this)},getMarkers:function(){return this._markers},_fireEdit:function(){this._poly.edited=!0,this._poly.fire("edit")},_onMarkerDrag:function(a){var b=a.target;L.extend(b._origLatLng,b._latlng),b._middleLeft&&b._middleLeft.setLatLng(this._getMiddleLatLng(b._prev,b)),b._middleRight&&b._middleRight.setLatLng(this._getMiddleLatLng(b,b._next)),this._poly.redraw(),this._poly.fire("editing")},_onMarkerDragEnd:function(a){var b,c=a.target;b=/^-\d+$/.test(c._leaflet_id)?"marker:add":"marker:modify",this._poly.fire(b,{layer:c}),this._fireEdit()},_onMarkerClick:function(a){var b=L.Polygon&&this._poly instanceof L.Polygon?4:3,c=a.target;this._poly._latlngs.length<b||(this._removeMarker(c),this._updatePrevNext(c._prev,c._next),c._middleLeft&&this._markerGroup.removeLayer(c._middleLeft),c._middleRight&&this._markerGroup.removeLayer(c._middleRight),c._prev&&c._next?this._createMiddleMarker(c._prev,c._next):c._prev?c._next||(c._prev._middleRight=null):c._next._middleLeft=null,this._fireEdit())},_updateIndexes:function(a,b){this._markerGroup.eachLayer(function(c){c._index>a&&(c._index+=b)})},_createMiddleMarker:function(a,b){var c,d,e,f=this._getMiddleLatLng(a,b),g=this._createMarker(f);g.setOpacity(.6),a._middleRight=b._middleLeft=g,d=function(){var d=b._index;g._index=d,g.off("click",c,this).on("click",this._onMarkerClick,this).on("dragend",this._fireEdit,this),f.lat=g.getLatLng().lat,f.lng=g.getLatLng().lng,this._poly.spliceLatLngs(d,0,f),this._markers.splice(d,0,g),this._poly.data.nd[0][0].splice(d,0,{ref:g._leaflet_id}),g.setOpacity(1),this._updateIndexes(d,1),b._index++,this._updatePrevNext(a,g),this._updatePrevNext(g,b),this._poly.fire("editstart")},e=function(){g.off("dragstart",d,this),g.off("dragend",e,this),this._createMiddleMarker(a,g),this._createMiddleMarker(g,b)},c=function(){this._poly.fire("marker:add",{layer:g}),d.call(this),e.call(this),this._fireEdit()},g.on("click",c,this).on("dragstart",d,this).on("dragend",e,this),this._markerGroup.addLayer(g)},_updatePrevNext:function(a,b){a&&(a._next=b),b&&(b._prev=a)},_getMiddleLatLng:function(a,b){var c=this._poly._map,d=c.project(a.getLatLng()),e=c.project(b.getLatLng());return c.unproject(d._add(e)._divideBy(2))}}),ME.Polyline.addInitHook(function(){ME.Edit.Poly&&(this.editing=new ME.Edit.Poly(this),this.options.editable&&this.editing.enable())}),ME.Polygon.addInitHook(function(){ME.Edit.Poly&&(this.editing=new ME.Edit.Poly(this),this.options.editable&&this.editing.enable())}),ME.Mode=L.Class.extend({includes:L.Mixin.Events,initialize:function(a,b){this._map=a,this._handler=b,this._enabled=!1,this.group=this._map.editingGroup,this._handler.on&&(this._handler.on("disabled",this._disable,this),this._handler.on("enabled",this._enable,this))},enable:function(){this._enabled||(ME.Mode._activeMode&&ME.Mode._activeMode.disable(),ME.Mode._activeMode=this,this._enabled=!0,this._handler.enable(),this.group=this._map.editingGroup,this.fire("enabled"),this._map.on("draw:created",this._finish,this))},disable:function(){this._enabled&&(this._enabled=!1,this._handler.disable(),delete this.group,this.fire("disabled"),this._map.off("draw:created",this._finish,this))},_disable:function(){this._enabled&&(this._enabled=!1,this.fire("disabled"),this._map.off("draw:created",this._finish,this))},_enable:function(){this._enabled||(this._enabled=!0,this.fire("enabled"),this._map.on("draw:created",this._finish,this))},enabled:function(){return this._enabled}}),ME.Mode.DrawCircle=ME.Mode.extend({initialize:function(a){var b;b=new L.Draw.Circle(a),ME.Mode.prototype.initialize.apply(this,[a,b])},_finish:function(a){var b=a.layerType,c=a.layer;"circle"==b&&(L.setOptions(c,{moveable:!0}),this.group.addLayer(c),c.editing.enable(),c.dragging.enable())}}),ME.Mode.DrawMark=ME.Mode.extend({initialize:function(a){var b;b=new ME.Draw.Marker(a),ME.Mode.prototype.initialize.apply(this,[a,b])},_finish:function(a){var b=a.layerType;"marker"==b&&this.group.addLayer(a.layer)}}),ME.Mode.DrawPolygon=ME.Mode.extend({initialize:function(a){var b;b=new ME.Draw.Polygon(a),ME.Mode.prototype.initialize.apply(this,[a,b])},_finish:function(a){var b=a.layer,c=a.layerType;"polygon"==c&&(L.setOptions(b,{moveable:!0,rotateable:!0}),this.group.addLayer(b),b.editEnable(),console.log(b.getLatLngs()))}}),ME.Mode.DrawPolyline=ME.Mode.extend({initialize:function(a){var b;b=new ME.Draw.Polyline(a),ME.Mode.prototype.initialize.apply(this,[a,b])},_finish:function(a){var b=a.layerType,c=a.layer;"polyline"==b&&this.group.addLayer(c)}}),ME.Mode.DrawAssistLine=ME.Mode.extend({initialize:function(a){var b=new ME.Draw.AssistLine(a);ME.Mode.prototype.initialize.apply(this,[a,b])},_finish:function(a){var b=a.layerType,c=a.layer;"assistline"==b&&this.group.addLayer(c)}}),ME.Mode.DrawAssistPolygon=ME.Mode.extend({initialize:function(a){var b=new ME.Draw.AssistPolygon(a);ME.Mode.prototype.initialize.apply(this,[a,b])},_finish:function(a){var b=a.layerType,c=a.layer;"assistpolygon"==b&&this.group.addLayer(c)}}),ME.Mode.DrawAssistMarker=ME.Mode.extend({initialize:function(a){var b=new ME.Draw.AssistMarker(a);ME.Mode.prototype.initialize.apply(this,[a,b])},_finish:function(a){var b=a.layerType,c=a.layer;"assistmarker"==b&&this.group.addLayer(c)}}),ME.Mode.DrawRectangle=ME.Mode.extend({initialize:function(a){var b;b=new L.Draw.Rectangle(a),ME.Mode.prototype.initialize.apply(this,[a,b])},_finish:function(a){var b=a.layerType,c=a.layer;"rectangle"==b&&(L.setOptions(c,{moveable:!0,rotateable:!0}),this.group.addLayer(c),c.editing.enable(),c.dragging.enable())}}),ME.Mode.SelectRoad=ME.Mode.extend({initialize:function(a){var b;b=new ME.Handler.SelectRoad(a),ME.Mode.prototype.initialize.apply(this,[a,b])},_finish:function(a){var b=a.roads,c=this;"pointSelectRoad"==a.pathtype&&b.forEach(function(a){var b=new ME.Entity.AssistLine(a);c.group.addLayer(b)})}}),ME.Mode.AreaSelectRoad=ME.Mode.extend({options:{},initialize:function(a){var b;b=new L.Draw.Polygon(a),ME.Mode.prototype.initialize.apply(this,[a,b])},_finish:function(a){var b,c=a.layer,d=a.layerType,e=[];"polygon"==d&&(b=c.getLatLngs(),b.forEach(function(a){e.push(a.lng+","+a.lat)}),e.push(e[0]),ME.Util.areaSelectRoad({url:ME.Config.data.areaSelectRoadNameUrl,latlngs:e.join(";")},function(a){alert(a.data&&a.data.length>0?a:"没有可导出的路")},this))}}),ME.Mode.AreaSelectLayers=ME.Mode.extend({initialize:function(){},_selecting:function(a){var b=a.bounds,c=this;this.group.eachLayer(function(a){var d=a._leaflet_id,e=c._intersect(b,a),f=c.group.selectedLayers.indexOf(d);e&&0>f?(c.group.selectedLayers.push(d),a.setState("select")):!e&&f>=0&&(c.group.selectedLayers.splice(f,1),a.setState("common"))})},_intersect:function(a,b){var c,d=[],e=this;if("assistline"!=b.type&&"assistpolygon"!=b.type&&"polyline"!=b.type)return!1;b.getLatLngs().forEach(function(a){d.push(e._map.latLngToContainerPoint(a))});for(var f=0,g=d.length-1;g>f;f++)if(c=L.bounds(d[f],d[f+1]),a.intersects(c))return!0;return!1}}),ME.Mode.BrowserMap=ME.Mode.extend({initialize:function(a){this._map=a,this._enabled=!1},enable:function(){this._enabled||(this._enabled=!0,ME.Mode._activeMode&&ME.Mode._activeMode.disable(),ME.Mode._activeMode=this,this.fire("enabled"))},disable:function(){this._enabled&&(this._enabled=!1,this.fire("disabled"))}}),ME.Mode.HollowPolygon=ME.Mode.extend({options:{deleteOrigins:!0},initialize:function(a){var b;L.setOptions(this),b=new L.Draw.Polygon(a),ME.Mode.prototype.initialize.apply(this,[a,b])},_finish:function(a){var b,c,d,e=a.layer,f=a.layerType;"polygon"==f&&(b=e.getLatLngs(),this.group.selectedLayers.length&&(c=this.group.getLayer(this.group.selectedLayers[0]),d=new ME.Donut([[c.getLatLngs(),b]]),this.group.addLayer(d),this.options.deleteOrigins&&this.group.removeLayer(c)))}}),ME.Control=L.extend({},L.Control,ME.Control),ME.Control.Button=L.Class.extend({options:{tagName:"a",className:"",attributes:["title","innerHTML"]},initialize:function(a){a&&a.name&&(a.handler||a.mode)&&(a.mode&&(a.handler=this._handlerForMode),this.name=a.name,this.enabled=!0,L.setOptions(this,a),this._createButton(this.options))},disable:function(){this.enabled&&(this.enabled=!1,this._removeEvent(),L.DomUtil.addClass(this.el,"disabled"),L.DomUtil.removeClass(this.el,"activated"))},enable:function(){this.enabled||(this.enabled=!0,this._bindEvent(),L.DomUtil.removeClass(this.el,"disabled"))},activated:function(){this.enabled=!1,this._removeEvent(),L.DomUtil.addClass(this.el,"activated")},deactivated:function(){this.enabled=!0,this._bindEvent(),L.DomUtil.removeClass(this.el,"activated")},_bindEvent:function(){var a=this.options.handler,b=this.el;L.DomEvent.on(b,"click",L.DomEvent.stopPropagation).on(b,"mousedown",L.DomEvent.stopPropagation).on(b,"dblclick",L.DomEvent.stopPropagation).on(b,"click",L.DomEvent.preventDefault),a&&L.DomEvent.on(b,"click",a,this)},_removeEvent:function(){var a=this.options.handler,b=this.el;L.DomEvent.off(b,"click",L.DomEvent.stopPropagation).off(b,"mousedown",L.DomEvent.stopPropagation).off(b,"dblclick",L.DomEvent.stopPropagation).off(b,"click",L.DomEvent.preventDefault),a&&L.DomEvent.off(b,"click",a,this)},onAdd:function(a){var b=this.options;a&&(this._map=a,!this.mode&&b.mode&&(this.mode=new b.mode(a),this.mode.on("enabled",this.activated,this),this.mode.on("disabled",this.deactivated,this)),this._bindEvent())},onRemove:function(){this._removeEvent(),this._map=null,this.mode&&this.mode.disable(),this.el.parentNode.removeChild(this.el)},_createButton:function(a){var b=L.DomUtil.create(a.tagName,a.className||"");L.DomUtil.addClass(b,"toolbar-button");for(var c,d=0;c=this.options.attributes[d++];)b[c]=a[c]?a[c]:"";this.el=b},_handlerForMode:function(){this.mode&&this.mode.enable()}}),ME.Control.Button.browserMap=new ME.Control.Button({name:"browserMap",title:"移动地图",className:"mapeditor-toolbar-pan-map",mode:ME.Mode.BrowserMap}),ME.Control.Button.hollowPolygon=new ME.Control.Button({name:"hollowPolygon",title:"生成镂空面",className:"mapeditor-toolbar-draw-hollowpolygon",mode:ME.Mode.HollowPolygon}),ME.Control.Button.hollowPolygon2=new ME.Control.Button({name:"hollowPolygon2",title:"选面生成镂空面",className:"mapeditor-toolbar-draw-hollowpolygon",handler:function(){var a=this._map,b=a.editingGroup,c=[];b.selectedLayers.forEach(function(a){var d,e=b.getLayer(a);e&&(d=e.type,"polygon"==d&&2!=c.length&&c.push(e))});var d=new ME.Donut([[c[0].getLatLngs(),c[1].getLatLngs()]]);b.addLayer(d),c.forEach(function(a){b.removeLayer(a)})}}),ME.Control.Button.drawPolyline=new ME.Control.Button({name:"drawPolyline",title:"画线",className:"mapeditor-toolbar-draw-polyline",mode:ME.Mode.DrawPolyline}),ME.Control.Button.drawPolygon=new ME.Control.Button({name:"drawPolygon",title:"画面",className:"mapeditor-toolbar-draw-polygon",mode:ME.Mode.DrawPolygon}),ME.Control.Button.drawAssistLine=new ME.Control.Button({name:"drawAssistLine",title:"画辅助线",className:"mapeditor-toolbar-draw-assistline",mode:ME.Mode.DrawAssistLine}),ME.Control.Button.drawAssistPolygon=new ME.Control.Button({name:"drawAssistPolygon",title:"画辅助面",className:"mapeditor-toolbar-draw-assistpolygon",mode:ME.Mode.DrawAssistPolygon}),ME.Control.Button.drawAssistMarker=new ME.Control.Button({name:"drawAssistMarker",title:"画辅助点",className:"mapeditor-toolbar-draw-assistmarker",mode:ME.Mode.DrawAssistMarker}),ME.Control.Button.drawCircle=new ME.Control.Button({name:"drawCircle",title:"画园",className:"mapeditor-toolbar-draw-circle",mode:ME.Mode.DrawCircle}),ME.Control.Button.drawRectangle=new ME.Control.Button({name:"drawRectangle",title:"画方",className:"mapeditor-toolbar-draw-rectangle",mode:ME.Mode.DrawRectangle}),ME.Control.Button.drawMarker=new ME.Control.Button({name:"drawMarker",title:"标注",className:"mapeditor-toolbar-draw-marker",mode:ME.Mode.DrawMark}),ME.Control.Button.pointSelectRoad=new ME.Control.Button({name:"pointSelectRoad",title:"点选路",className:"mapeditor-toolbar-road-pointroad",mode:ME.Mode.SelectRoad}),ME.Control.Button.areaSelectRoad=new ME.Control.Button({name:"areaSelectRoad",title:"区域选路",className:"mapeditor-toolbar-road-arearoad",mode:ME.Mode.AreaSelectRoad}),ME.Control.Button.getPolygonFromRoads=new ME.Control.Button({name:"getPolygonFromRoads",title:"生成区域",className:"mapeditor-toolbar-road-roadstoarea",handler:function(){var a=ME.Config.data.getPolygonFromRoadsUrl,b=[],c=this._map,d=c.editingGroup;d.selectedLayers.forEach(function(a){var c,e=d.getLayer(a);if(e){c=e.type;var f=e.getLatLngs(),g=[];f.forEach(function(a){g.push(a.lng+","+a.lat)}),("polygon"==c||"assistpolygon"==c||("polyline"==c||"assistline"==c)&&e.closed===!0)&&g.push(g[0]),b.push(g.join(";"))}}),ME.Util.roadsToArea({url:a,line:b.join("-")},function(a){a=JSON.parse(a),a.data.forEach(function(a){var b=a.split(";"),c=[];b.forEach(function(a){var b=a.split(","),d=new L.LatLng(b[1],b[0]);c.push(d)});var e=new ME.Polygon({latlngs:c});d.clearSelectedLayers({remove:!0}),d.addDataLayer(e)})}),ME.Mode._activeMode&&ME.Mode._activeMode.disable()}}),ME.Control.Button.save=new ME.Control.Button({name:"save",title:"保存编辑",className:"mapeditor-toolbar-actions-save",handler:function(){var a=this._map,b=a.editingGroup;b.saveLayers.call(b)}}),ME.Control.Button.cancel=new ME.Control.Button({name:"cancel",title:"取消",className:"mapeditor-toolbar-actions-cancel",handler:function(){var a=this._map,b=a._currentpath;b&&(b.dragging.disable(),b.editing.disable(),b.setLatLngs(b._originalCoord))}}),ME.Control.Button.deleteShape=new ME.Control.Button({name:"deleteShape",title:"删除选中图形",className:"mapeditor-toolbar-actions-delete",handler:function(){var a=this._map,b=a.editingGroup;b.clearSelectedLayers({remove:!0})}}),ME.Control=L.extend({},L.Control,ME.Control),ME.Control.Toolbar=L.Control.extend({options:{className:"",toolbarClassName:"mapeditor-toolbar-bar",direction:"v"},initialize:function(a){var b;L.Control.prototype.initialize.call(this,a),b=this._container=L.DomUtil.create("div",this.options.toolbarClassName),L.DomUtil.addClass(b,this.options.direction),this.options.className&&L.DomUtil.addClass(b,this.options.className),this._buttons={}},onAdd:function(a){var b=this.options.buttons||[],c=this;return this._map=a,b.forEach(function(a){c.addButton(a)}),this._container},onRemove:function(){for(var a in this._buttons)this._buttons.hasOwnProperty(a)&&this._buttons[a].onRemove();this._buttons={},this._map=null},addButtons:function(a){for(var b,c=0;b=a[c++];)this.addButton(b)},addButton:function(a){var b,c=this._container,d=this._buttons,e=!Object.keys(d).length;b=a instanceof ME.Control.Button?a:new ME.Control.Button(a),b.el&&(this.options.buttons=this.options.buttons||[],this.options.buttons.push(b),this._map&&(this._buttons[b.name]||(e&&L.DomUtil.addClass(b.el,"first"),Object.keys(d).forEach(function(a){L.DomUtil.removeClass(d[a].el,"last")}),L.DomUtil.addClass(b.el,"last"),c.appendChild(b.el),this._buttons[b.name]=b,b.onAdd(this._map))))},getButton:function(a){return this._buttons[a]},disableButton:function(a){var b=this._buttons[a];b&&b.disable()},enableButton:function(a){var b=this._buttons[a];b&&b.enable()},removeButton:function(a){var b=this._buttons[a];b&&(delete this._buttons[a],b.onRemove())}}),ME.Control.Button=L.Class.extend({options:{tagName:"a",className:"",attributes:["title","innerHTML"]},initialize:function(a){a&&a.name&&(a.handler||a.mode)&&(a.mode&&(a.handler=this._handlerForMode),this.name=a.name,this.enabled=!0,L.setOptions(this,a),this._createButton(this.options))},disable:function(){this.enabled&&(this.enabled=!1,this._removeEvent(),L.DomUtil.addClass(this.el,"disabled"),L.DomUtil.removeClass(this.el,"activated"))},enable:function(){this.enabled||(this.enabled=!0,this._bindEvent(),L.DomUtil.removeClass(this.el,"disabled"))},activated:function(){this.enabled=!1,this._removeEvent(),L.DomUtil.addClass(this.el,"activated")},deactivated:function(){this.enabled=!0,this._bindEvent(),L.DomUtil.removeClass(this.el,"activated")},_bindEvent:function(){var a=this.options.handler,b=this.el;L.DomEvent.on(b,"click",L.DomEvent.stopPropagation).on(b,"mousedown",L.DomEvent.stopPropagation).on(b,"dblclick",L.DomEvent.stopPropagation).on(b,"click",L.DomEvent.preventDefault),a&&L.DomEvent.on(b,"click",a,this)},_removeEvent:function(){var a=this.options.handler,b=this.el;L.DomEvent.off(b,"click",L.DomEvent.stopPropagation).off(b,"mousedown",L.DomEvent.stopPropagation).off(b,"dblclick",L.DomEvent.stopPropagation).off(b,"click",L.DomEvent.preventDefault),a&&L.DomEvent.off(b,"click",a,this)},onAdd:function(a){var b=this.options;a&&(this._map=a,!this.mode&&b.mode&&(this.mode=new b.mode(a),this.mode.on("enabled",this.activated,this),this.mode.on("disabled",this.deactivated,this)),this._bindEvent())},onRemove:function(){this._removeEvent(),this._map=null,this.mode&&this.mode.disable(),this.el.parentNode.removeChild(this.el)},_createButton:function(a){var b=L.DomUtil.create(a.tagName,a.className||"");L.DomUtil.addClass(b,"toolbar-button");for(var c,d=0;c=this.options.attributes[d++];)b[c]=a[c]?a[c]:"";this.el=b},_handlerForMode:function(){this.mode&&this.mode.enable()}}),ME.Control.Button.browserMap=new ME.Control.Button({name:"browserMap",title:"移动地图",className:"mapeditor-toolbar-pan-map",mode:ME.Mode.BrowserMap}),ME.Control.Button.drawPolyline=new ME.Control.Button({name:"drawPolyline",title:"画线",className:"mapeditor-toolbar-draw-polyline",mode:ME.Mode.DrawPolyline}),ME.Control.Button.drawPolygon=new ME.Control.Button({name:"drawPolygon",title:"画面",className:"mapeditor-toolbar-draw-polygon",mode:ME.Mode.DrawPolygon}),ME.Control.Button.drawAssistLine=new ME.Control.Button({name:"drawAssistLine",title:"画辅助线",className:"mapeditor-toolbar-draw-assistline",mode:ME.Mode.DrawAssistLine}),ME.Control.Button.drawAssistPolygon=new ME.Control.Button({name:"drawAssistPolygon",title:"画辅助面",className:"mapeditor-toolbar-draw-assistpolygon",mode:ME.Mode.DrawAssistPolygon}),ME.Control.Button.drawAssistMarker=new ME.Control.Button({name:"drawAssistMarker",title:"画辅助点",className:"mapeditor-toolbar-draw-assistmarker",mode:ME.Mode.DrawAssistMarker}),ME.Control.Button.drawCircle=new ME.Control.Button({name:"drawCircle",title:"画园",className:"mapeditor-toolbar-draw-circle",mode:ME.Mode.DrawCircle}),ME.Control.Button.drawRectangle=new ME.Control.Button({name:"drawRectangle",title:"画方",className:"mapeditor-toolbar-draw-rectangle",mode:ME.Mode.DrawRectangle}),ME.Control.Button.drawMarker=new ME.Control.Button({name:"drawMarker",title:"标注",className:"mapeditor-toolbar-draw-marker",mode:ME.Mode.DrawMark}),ME.Control.Button.pointSelectRoad=new ME.Control.Button({name:"pointSelectRoad",title:"点选路",className:"mapeditor-toolbar-road-pointroad",mode:ME.Mode.SelectRoad}),ME.Control.Button.areaSelectRoad=new ME.Control.Button({name:"areaSelectRoad",title:"区域选路",className:"mapeditor-toolbar-road-arearoad",mode:ME.Mode.AreaSelectRoad}),ME.Control.Button.getPolygonFromRoads=new ME.Control.Button({name:"getPolygonFromRoads",title:"生成区域",className:"mapeditor-toolbar-road-roadstoarea",handler:function(){var a="http://119.90.32.30/gbox/gate?sid=8002",b=[],c=this._map,d=c.editingGroup;d.selectedLayers.forEach(function(a){var c,e=d.getLayer(a);if(e){c=e.type;var f=e.getLatLngs(),g=[];f.forEach(function(a){g.push(a.lng+","+a.lat)}),("polygon"==c||"assistpolygon"==c||("polyline"==c||"assistline"==c)&&e.closed===!0)&&g.push(g[0]),b.push(g.join(";"))}}),ME.Util.roadsToArea({url:a,line:b.join("-")},function(a){a=JSON.parse(a),a.data.forEach(function(a){var b=a.split(";"),c=[];b.forEach(function(a){var b=a.split(","),d=new L.LatLng(b[1],b[0]);c.push(d)});var e=new ME.Polygon({latlngs:c});d.clearSelectedLayers({remove:!0}),d.addDataLayer(e)})}),ME.Mode._activeMode&&ME.Mode._activeMode.disable()}}),ME.Control.Button.save=new ME.Control.Button({name:"save",title:"保存编辑",className:"mapeditor-toolbar-actions-save",handler:function(){var a=this._map,b=a.editingGroup;b.saveLayers.call(b)}}),ME.Control.Button.cancel=new ME.Control.Button({name:"cancel",title:"取消",className:"mapeditor-toolbar-actions-cancel",handler:function(){var a=this._map,b=a._currentpath;b&&(b.dragging.disable(),b.editing.disable(),b.setLatLngs(b._originalCoord))}}),ME.Control.Button.deleteShape=new ME.Control.Button({name:"deleteShape",title:"删除选中图形",className:"mapeditor-toolbar-actions-delete",handler:function(){var a=this._map,b=a.editingGroup;b.clearSelectedLayers({remove:!0})}}),ME.Util=ME.Util||{},ME.Util.pointSelectRoad=function(a,b,c){var d=new XHR({cross:!0,fla:!0});d.getJSON(a.url,{paras:{xy:a.lng+","+a.lat}},function(a){console.log(a),"function"==typeof b&&b.apply(c,[a])})},ME.Util.areaSelectRoad=function(a,b,c){var d=new XHR({cross:!0,fla:!0});d.get(a.url,{paras:{region:a.latlngs}},function(a){"function"==typeof b&&b.apply(c,[a])})},ME.Util.roadsToArea=function(a,b,c){var d=new XHR({cross:!0,fla:!0});d.post(a.url,{paras:{line:a.line}},function(a){"function"==typeof b&&b.apply(c,[a])})},ME.Util.getCityRing=function(a,b,c){var d=new XHR({cross:!0,fla:!0});d.getJSON(ME.Config.data.getCityRingUrl,{paras:{city:encodeURI(a.city),name:encodeURI(a.name)}},function(a){"function"==typeof b&&b.apply(c,[a])})};